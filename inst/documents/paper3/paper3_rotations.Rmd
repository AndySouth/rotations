---
title: "Insecticide rotations delay evolution of resistance in a minority of model runs when compared to sequential use."
# output: 
#   pdf_document:
#     keep_tex: true
#     fig_caption: true
#     latex_engine: pdflatex

output: word_document
#author: "Andy South and Ian Hastings"
#date: "`r Sys.Date()`"
bibliography: library.bib
csl: biomed-central.csl
fontsize: 11pt
spacing: double
# below worked in test_linenumbers.Rmd
header-includes:
   - \usepackage{setspace}
   - \doublespacing
   - \usepackage{lineno}
   - \linenumbers
---

Andy South * and Ian M. Hastings

Department of Parasitology, Liverpool School of Tropical Medicine, Liverpool L3 5QA, UK.

southandy@gmail.com, andy.south@lstmed.ac.uk   

ian.hastings@lstmed.ac.uk

\* Corresponding author



```{r, eval=TRUE, include=FALSE}
#!!!! PAPER PROTOCOL
#!!!! submission MS, knit to word_document 
#!!!!  in WORD: delete figs, set double space, add line numbers 
#!!!!  (spacing & line numbers work for pdf output but not for word)
library(knitr)
opts_chunk$set(dev="tiff",
               dev.args=list(compression="lzw"),
               dpi=300,
               cache=FALSE,
               fig.path='pap3figs/')
```

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
  library(rotations)
  library(ggplot2)
  library(gridExtra)

  outFolder <- "C:\\Dropbox\\resistanceResults\\rotations\\"
  
  # load simulation outputs for some plots
  # beware that each object is called df_res_all
  # some plots are created by directly running the model
  load("df_res_all_rot_nocost_nomig1000.rda") #nocost nomig  
  df_nocost_nomig <- df_res_all
  load("df_res_all_rot10000.rda") #cost
  df_cost <- df_res_all
  load("df_res_all_rot_mig10000.rda") #mig 10k
  df_mig <- df_res_all
  load("df_res_all_rot_cost_mig10000.rda") #costmig 10k
  df_cost_mig <- df_res_all
  
```

## Abstract

Insecticide resistance threatens the control of the vectors of dangerous diseases including malaria, dengue and zika. Recent increases in insecticide resistance in public health are an evolutionary process caused by sustained exposure of insect populations to a small number of available insecticides. Resistance is a particular problem in public health as compared to agriculture because insecticides need to be longer lasting to provide affordable protection and there are fewer available active ingredients. Efforts to limit the development of insecticide resistance are grouped under the term Insecticide Resistance Management (IRM). The main strategies advocated to reduce the development of resistance are 1) rotations, 2) sequences, 3) mixtures  and 4) mosaics. Rotations regularly switch between the use of different insecticides with a short time step (one or a few years) irrespective of resistance levels. Sequences, in contrast, switch from one insecticide to another only when resistance levels have reached a critical, defined threshold usually over a longer timescale.  
    
Rotations are often advocated as one of the best options for limiting the development of resistance.
    
Testing different IRM strategies in the field is difficult and there has been little recent modelling work on insecticide rotations.
    
In this paper a model is described allowing rotations and sequences to be compared in terms of their effect on the evolution of insecticide resistance. The model is used to develop a mechanistic understanding of when and why insecticide resistance is likely to evolve faster with rotations or sequences.  
    
The results suggest that under more likely circumstances than not the evolution of insecticide resistance will reach resistance thresholds at very similar times for rotations and sequences.
    
However under a less common, but still plausible, set of circumstances there are predicted to be large adavnatages to using a rotations as compared to a sequence.

    
The advantages to a rotation only occur when there are costs of resistance or dispersal from untreated areas, and there is high dominance of cost and low dominance of selection.
    
    
The mechanisms for these results are explained. 
    
Other operational factors will favour rotations or sequences aside from the implications for the evolution of resistance. Developing an understanding of the evolutionary implications allows a more explicit consideration of these other factors on their own merits. 


\pagebreak

## Introduction
Despite much field and modelling work on the evolution of resistance under different insecticide or drug strategies [@Consortium2013] there is a small evidence base to support decisions about the use of insecticides in public health [@Sternberg2017].   

Rotations are advocated as one of the most favoured approaches for Insecticide Resistance Management (IRM)[@WHO2012].

In a rotation the insecticide used is changed on a set time interval irrespective of resistance levels. Sequential use, in contrast, denotes the practice of using an insecticide until resistance to it reaches a certain threshold and then switching to another. Different rotation time intervals can be considered, e.g. in vector control for Malaria, Indoor Residual Spraying may be repeated every year (around 10 anopheles mosquito generations) and Insecticide Treated Nets may be replaced every two years (around 20 generations). Multiples of these intervals could be used as the rotation interval. Multiple generational rotations like this contrast with the situation in agriculture where a rotation is sometimes more tightly defined as having an interval of a single generation [@Sudo2017].

Here a modern modelling approach is described to allow an assessment of the potential benefits, in terms of the evolution of resistance, of rotations over sequences. 


## Methods

A population genetic model was developed tracking the change in resistance allele frequency as consequence of the genetic determination of the resistance phenotype, and the deployment policy for the insecticides. The model uses a similar approach to that previously used to compare insecticide mixtures and sequences [@Levick2017,@South2018]. The implementation is simpler here because for rotations and sequences there is only a need to follow one insecticide at a time and linkage disequilibrium can be ignored. The simpler implementation allows the model to be run for an unlimited number of insecticides. The algebra behind the model is described in the supplementary information.
    
1. Sequences : one insecticide is used until resistance threshold frequency (0.5 in this case) is reached, then switch to a new insecticide. 

2. Rotations : use insecticide for set time (i.e. number of insect generations), switch to another. 

In both cases the choice of the new insecticide to use was made by going through the list of available insecticides and choosing the next one for which resistance was below the threshold. Thus there is the potential to switch back to insecticides that had been used earlier in a model run if resistance had not reached the threshold or if resistance had declined below the threshold during a period when not in use. This means that the “sequential” policy is effectively a “rotate when resistant” policy but we use the former term for consistency with previous work. *todo cite different trems from Rex consortium review* For both rotations and sequences the simulation continues until no more insecticides remain below their resistance thresholds.    
    
Within the model inputs effect fitness as shown in Figure 1, differences in fitness lead to the changes in allele frequencies over time.

**Table 1. Model inputs and the ranges used in simulations**

Input  | Description | Min | Max
---------------------- | ------------------------------------- | ----- | -----
Effectiveness | proportion of susceptible (SS) insects killed by exposure to insecticide | 0.5 | 1
Exposure | proportion of females exposed to insecticide | 0.4 | 0.9
Male exposure | proportion of males exposed to insecticide as proportion of females | 0 | 1
Resistance restoration  | ability of resistance (RR) to restore fitness of insects exposed to insecticide | 0.1 | 0.9
Dominance of resistance | sets fitness of heterozygous (SR) insects between that of SS & RR in presence of insecticide | 
Frequency  | frequency of resistance alleles within the population | 0.005 | 0.1
Cost of resistance  |  fitness of resistant (RR) insects in absence of insecticide | 0 | 0.1
Dominance of cost  | sets fitness of heterozygous (SR) insects between that of SS & RR in absence of insecticide | 0.1 | 0.9
Insecticide number | number of independent insecticides available | 2 | 5  
Rotation interval | number of generations to use insecticide before switching | 5 | 50
Coverage | for scenarios with dispersal, the proportion of insects in the treated area rather than untreated refugia |  0.1 | 0.9
Dispersal | proportion of population exchanged between treated and untreated areas per generation, 0=none, 1=random mixing |  0.1 | 0.9

    

The model was run under four main scenarios :

1. baseline : no resistance fitness costs or dispersal to/from untreated refugia
2. fitness costs of resistance added
3. dispersal link to untreated areas (no costs)
4. costs and dispersal


For each scenario 10,000 runs were performed randomly selecting inputs according to the ranges specified in Table 1 using a uniform distribution in all cases.


#### Assessing relative performance of insecticide use strategies

*todo change this bit*
It is necessary to choose a measure to quantify the performance of an insecticide-use strategy and enable comparison with an alternative. For this we summed the number of generations when an insecticide was deployed and the resistance allele frequency for that insecticide was below 0.5. This allowed comparison between strategies using a variable number of insecticides. Previously time-to-resistance, namely the number of generations it takes to reach a defined resistance threshold (usually a resistance allele frequency of 0.5), was used. Using time-to-resistance worked when considering just two insecticides, but when the number of insecticides is a variable it is not sufficient.


## Results

Example model runs are shown with no costs or dispersal (Fig 1), with just resistance costs (Fig 2) and with just dispersal from untreated refugia (Fig 3).

*todo describe these example runs first, before talking about overall results*

#### Results1. form of resistance evolution with and without costs and dispersal.

When there are no resistance fitness costs or dispersal links to untreated refugia resistance frequencies do not decline when an insecticide is not in use (Fig 1). Thus for sequences once resistance thresholds are reached the resistance frequencies remain at that level and the insecticide cannot be re-used. For rotations resistance frequencies step upwards when insecticides are in use and remain at a plateau when they are not. If the rotation interval is short enough then the insecticide can be used a few times before the resistance thresholds are reached.



### Results2 : comparing rotations and sequences across model runs.

In all the example runs shown the resistance threshold (allele frequency of 0.5) was reached within the course 500 generations which was the maximum limit imposed in the model. Across all model runs there were many in which the thresholds were not reached in this time period.   

*but first need to explain that sequences pretty much never better*
*so show the modified histograms first, i.e. don't filter out the threshold not reached runs*

Thus to aid the comparison of rotations and sequences model runs can be broadly classified into three groups :




When there were no costs or dispersal there was no difference between rotations and sequences in the number of generations below the resistance threshold (Fig 4.1).

*todo : maybe I should just leave the 'succeeded' runs in here which would change these %s slightly*
With fitness costs included 67% of model runs, similar to those in the previous section, gave no difference between rotations and sequences in the number of generations below the resistance threshold. In contrast, 7% of model runs generated an advantage of greater than 20% for rotations over sequences (Fig 4.2). 

Dispersal from untreated refugia gives smaller benefits of rotations over sequences and in fewer runs (Fig 4.3).

With both costs and dispersal the benefits of rotations are similar to when runs have costs alone (Fig 4.4).

#### Runs where rotations have substantial advantage over sequences

*Talk about classing runs into both 'succeeded', both 'failed' or just rotation succeeded.
*show violin plots here ?*

As shown in Fig 4.2 some runs with costs of resistance can show substantial advantages for rotations over sequences. Examples of one such run is shown in Fig 5.

A Partial Rank Correlation analysis identified that of the inputs, dominance of cost and dominance of selection had the greatest influence on the difference between rotations and sequences when resistance costs were included (Fig 6). A combination of high values of dominance of cost and low values for dominance of selection are required to give the greatest advantages to rotations, but do not guarantee this advantage (Fig 7). 


## Discussion

Comparing time below resistance thresholds for rotations and sequences, the model shows :

1. rotations and sequences the same when no costs or dispersal
2. with resistance costs, 67% of runs the same for rotations and sequences, but 6-7% of runs have > 20% advantage for rotations
3. with dispersal from untreated refugia but no costs, small advantage of rotations but very few runs < 0.1% have >20% advantage.

This can be understood intuitively. When there are no costs, the dynamics are the same, it is simply that sequential deployment proceeds in a few, larger steps while rotations proceeds in more numerous smaller steps; both reach the same point in around the same time (e.g. figs 1 and 3). However dominance effects on cost and resistance can act to keep frequencies low in a rotations policy. Recall that at low frequencies of resistance most resistance alleles are present as heterozygotes RS and only a vey small proportions heterozygotes. However costs are dominant and still act at low frequencies. This is illustrated on Figure Y. Relatively rapid rotations keep the allele frequencies at the LH side of Figure Y where costs during the periods when the insecticide is not deployed greatly outweigh the selection for IR during the periods when the insecticide is deployed. We believe the explanation is therefore that rotations keep allele frequencies in the parameter space to the left of Figure Y and hence acts to slow the evolution of IR compared to sequences which allow frequencies to rise to relatively high levels before the insecticide is replaced.  (does this sound reasonable??). Note also that starting frequency, as expected, had an impact (Figure 7), lower starting frequencies slightly favouring rotations by allowing more time in the “low frequency” parameter space.

In rare circumstances, when there are costs of resistance, rotations can lead to the resistance frequencies for a group of insecticides being kept below resistance thresholds for the length of the simulations where sequences run out of insecticides within around 100 generations. Is it possible that these rare circumstances where parameter values are 'just-right' could be implemented operationally ? The problem is that these rare circumstances rely on high costs of resistance, high dominance of these costs and low dominance of the selection for the resistance itself. These parameters are all not easy to measure and there isn't agreement on their likely values [@Kliot2012, @Bourguet2000]. 

Note however that this combination of recessive resistance and high dominance costs are exactly the features most desirable in any insecticide irrespective of how it is deployed. We discuss fitness below but note here that it is very difficult to maintain insecticide concentration at the level required to make resistance recessive. Concentrations decay post-application in most deployment strategies and this cause resistance to gradually change from being recessive to being dominant; see Figure 1 of <cite Levick et al> and our more extensive discussion in <cite South et al WoS manuscript).

The importance of resistance costs for substantial evolutionary benefits of rotations over sequences points to the importance of the debate over the fitness costs of insecticide resistance e.g. [@Kliot2012].
*extend this discussion of fitness costs*

We also found frequency of rotations had little effect. This is important in the control of vectors of human diseases such as malaria and dengue. These predominantly occur in resource-poor areas often with poor healthcare infrastructure. Experience suggests that rotation targets would often be missed (e.g rotations occur approximately every 15 generations rather than the planned “official” 10 generations) but our simulations suggest this would not fatally undermine a rotations policy.


### Caveats

The model does not include the potential effects of modifier genes ameliorating the costs of resistance alleles. To include this would require a more detailed model tracking linkage disequilibrium between each resistance locus and its modifier. It has been suggested that rotations could be favoured as a strategy because they keep resistance frequences lower and restrict selection pressure for modifier genes [@WHO2012]. However, there is little evidence to support the existence of such modifier genes in insectide resistance []. Even with the existence of modifier genes it is unlikely that they would provide much of an advantage to rotations in the scenarios we describe. In the modelled scenarios the use of an insecticide is stopped when the resistance frequency for that insecticide reaches 0.5. Thus in all scenarios resistance frequencies do not remain at high levels for long. In this situation it seems unlikely that modifiers would be selected for. 


### Conclusions

In their effect on the evolution of insecticide resistance, rotations and sequences are most often the same. If costs of resistance are included, infrequently (less than 7% of model runs set between plausible limits) there are substantial benefits to the rotation strategy over a sequence. There was never a substantial benefit of a sequence over a rotation. Whether or not insecticide rotations are predicted to offer sizeable benefits over sequences is dependent on coarse and fine scale issues about the nature of insecticide resistance that are yet to be agreed upon. The model shows that resistance costs are necessary to provide a substantial evolutionary advantage to rotations. However even when these requirements are satisfied particular combinations of inputs are required to generate the advantage of rotations.

The model only compares rotations and sequences in terms of their effect on the evolution of resistance. There are other operational reasons for why a sequence or a rotation may be favoured.

In summary, we show that rotations are invariably better than sequential use, although the difference may often be small (figure 4); certainly rotations should not be seen as a panacea capable of removing the threat of resistance evolution. Rotations may have a large impact if fitness costs are prints and dominant (these are genetic/physiological factors outside our control)  and if resistance can be kept recessive. The latter is under our control to some extent (fig 1 of Levick et al ) but it is extremely difficult to deploy and maintain insecticide concentrations at levels that ensure recessively (cite WoS ms): as concentrations decline resistance become dominant and any befits of rotations largely disappear.

## TODO
*try to come up with brief name for model output to make it easier to refer to it later*
*add caveat about polygenic resistance*
*The caption to each graph needs to have the list of parameter values used to generate them*
*work on Ians fig Y to help explanation*

\pagebreak

## Figures

```{r Fig1, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.width=9, fig.show='hold', fig.align='center', fig.cap="Figure 1. Comparing the increase in resistance frequencies over time for a rotation and a sequence when there no resistance fitness costs or dispersal from untreated refugia. The upper plot shows a rotation with a regular interval of 10 generations and the lower plot a sequence when the insecticide is changed when a resistance threshold of 0.5 is reached. In this example the rotation and the sequence reach the endpoint, resistance frequency > 0.5 to all insecicides, at the same time. For the sequence the resistance frequency for each insecticide increases to reach the threshold in one step and that insecticide cannot be used again. For the rotation the resistance frequency for each insecticide increases in shorter steps while it is in use and remains at the constant level while not. There are three insecticides, the resistance frequency for each is shown in the sub-plots, and the shaded boxes within each sub-plot show when that insecticide was in use. All other inputs are kept constant between the rotation and the sequence."}

# revisit how best to do model runs from within the paper 

linputs <- list()

linputs$n_insecticides <- 3
linputs$coverage <- 1
#linputs$migration <- 0.1
linputs$cost <-     0 
linputs$max_gen <-  200
linputs$expo_hi <-  0.6
linputs$eff <-      0.6
linputs$dom_sel <-  1
linputs$dom_cos <-  1
linputs$plot <-     FALSE

linputs$rot_interval=0
dfseq <- do.call(run_rot, linputs)
linputs$rot_interval=10
dfrot <- do.call(run_rot, linputs)

ggrot <- rot_plot_resistance(dfrot, plot_refuge=FALSE, logy=TRUE, plot=FALSE)
ggseq <- rot_plot_resistance(dfseq, plot_refuge=FALSE, logy=TRUE, plot=FALSE)
library(gridExtra)
grid.arrange(ggrot, ggseq, ncol=1)

``` 

\pagebreak

```{r Fig2, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.width=9, fig.show='hold', fig.align='center', fig.cap="Figure 2. Comparing the increase in resistance frequencies over time for a rotation and a sequence when there are resistance fitness costs. The upper plot shows a rotation with a regular interval and the lower plot a sequence when the insecticide is changed when a resistance threshold of 0.5 is reached. In this example the rotation lasts longer than the sequence. For the sequence the resistance frequency for each insecticide increases to reach the threshold in one step but in contrast to the previous figure resistance frequencies decline when the insecticide is not in use allowing it to be used again. For the rotation the resistance frequency for each insecticide increases in shorter steps while it is in use and similarly declines  while not. There are three insecticides, the resistance frequency for each is shown in the sub-plots, and the shaded boxes within each sub-plot show when that insecticide was in use. The simulation is stopped when there are no remaining insecticides for which the resistance frequency is below the threshold. All other inputs are kept constant between the rotation and the sequence."}

# revisit how best to do model runs from within the paper 

linputs <- list()

linputs$n_insecticides <- 3
linputs$coverage <- 1
#linputs$migration <- 0.1
linputs$cost <-     0.05 
linputs$max_gen <-  200
linputs$expo_hi <-  0.6
linputs$eff <-      0.6
linputs$dom_sel <-  1
linputs$dom_cos <-  1
linputs$plot <-     FALSE

linputs$rot_interval=0
dfseq <- do.call(run_rot, linputs)
linputs$rot_interval=10
dfrot <- do.call(run_rot, linputs)

ggrot <- rot_plot_resistance(dfrot, plot_refuge=FALSE, logy=TRUE, plot=FALSE)
ggseq <- rot_plot_resistance(dfseq, plot_refuge=FALSE, logy=TRUE, plot=FALSE)
library(gridExtra)
grid.arrange(ggrot, ggseq, ncol=1)

``` 

\pagebreak

```{r Fig3, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.width=9, fig.show='hold', fig.align='center', fig.cap="Figure 3. Comparing the increase in resistance frequencies over time for a rotation and a sequence with dispersal from untreated refugia. The upper plot shows a rotation with a regular interval and the lower plot a sequence when the insecticide is changed when a resistance threshold of 0.5 is reached. In this example the rotation and the sequence last the same time. In both cases the resistance frequencies in the treated areas (red lines) increase when an insecticide is in use. Resistance frequencies in the untreated areas (blue lines) increase after those in the treated areas as a result of dispersal from the treated areas. When an insecticide stops being used the resistance frequency in the treated area declines due to dispersal from the untreated area. For the sequence the resistance frequency for each insecticide increases to reach the threshold in one step and consistent with the previous figure resistance frequencies decline when the insecticide is not in use allowing it to be used again. For the rotation the resistance frequency for each insecticide increases in shorter steps while it is in use and similarly declines while not. There are three insecticides, the resistance frequency for each is shown in the sub-plots, and the shaded boxes within each sub-plot show when that insecticide was in use. The simulation is stopped when there are no remaining insecticides for which the resistance frequency is below the threshold. All other inputs are kept constant between the rotation and the sequence."}

# revisit how best to do model runs from within the paper 

linputs <- list()

linputs$n_insecticides <- 3
linputs$coverage <- 0.5
linputs$migration <- 0.1
linputs$cost <-     0 
linputs$max_gen <-  200
linputs$expo_hi <-  0.6
linputs$eff <-      0.6
linputs$dom_sel <-  1
linputs$dom_cos <-  1
linputs$plot <-     FALSE

linputs$rot_interval=0
dfseq <- do.call(run_rot, linputs)
linputs$rot_interval=10
dfrot <- do.call(run_rot, linputs)

ggrot <- rot_plot_resistance(dfrot, plot_refuge=TRUE, logy=TRUE, plot=FALSE)
ggseq <- rot_plot_resistance(dfseq, plot_refuge=TRUE, logy=TRUE, plot=FALSE)
library(gridExtra)
grid.arrange(ggrot, ggseq, ncol=1)

``` 

\pagebreak

```{r Fig4, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.width=9, fig.show='hold', fig.align='center', fig.cap="Figure 4. Effect of cost and dispersal on the difference between rotations and sequences from model runs. The y axis shows the number of model runs for the different caegories of difference between rotations and sequences. 4.1 when there are no resistance costs or dispersal from untreated refugia, rotations and sequences produce the same results. 4.2, 4.4 when costs are added there are infrequent model runs where rotations last longer below resistance thresholds than sequences. For between 6 and 7% of runs including costs, rotations last more than 20% longer than sequences. 4.3 when dispersal from untreated refugia is included without costs there are even less frequent runs where rotations last longer than sequences (in just 4 out of 10000 runs rotations lasted greater than 20% longer than sequences)."}

  # remove runs where thresholds not reached for seq & rot
  # with cost_mig ~ 65% of runs don't reach thresholds
  # could get this func to output perecnt not reaching
  rem_thresh_not_reached <- function(x) {x %>% filter(gens_seq != max_gen | gens_rot != max_gen)}

  df_nocost_nomig <- rem_thresh_not_reached(df_nocost_nomig)
  df_cost <- rem_thresh_not_reached(df_cost) #6.6
  df_mig <- rem_thresh_not_reached(df_mig) #0.05
  df_cost_mig <- rem_thresh_not_reached(df_cost_mig) #6.9
  
  # add a column for percent difference between rot & seq
  df_nocost_nomig <- mutate(df_nocost_nomig, pcent_rot_adv = rot_minus_seq * 100/gens_seq)
  df_cost <- mutate(df_cost, pcent_rot_adv = rot_minus_seq * 100/gens_seq)
  df_mig <- mutate(df_mig, pcent_rot_adv = rot_minus_seq * 100/gens_seq)
  df_cost_mig <- mutate(df_cost_mig, pcent_rot_adv = rot_minus_seq * 100/gens_seq)

  # calc % of runs where rotations > 20% better
  pcent_runs_rot_20pc_better <- function(x){ x %>%
                  filter(rot_minus_seq/gens_seq >= 0.2 ) %>%
                  summarise(n=n()) %>% 
                  #unlist() %>%
                  mutate(pcent=n*100/nrow(x)) }
  
  # pcent_runs_rot_20pc_better(df_nocost_nomig)
  # pcent_runs_rot_20pc_better(df_cost)
  # pcent_runs_rot_20pc_better(df_mig)
  # pcent_runs_rot_20pc_better(df_cost_mig)
  
  # log scale overemphasised low values
  # sqrt scale looked good but Ian didn't like

  custom_bins <- c(-20,-1,1,20,100,450)
  df_nocost_nomig$rot_adv_bins <- cut(df_nocost_nomig$pcent_rot_adv, custom_bins)
  df_cost$rot_adv_bins <- cut(df_cost$pcent_rot_adv, custom_bins)
  df_mig$rot_adv_bins <- cut(df_mig$pcent_rot_adv, custom_bins)
  df_cost_mig$rot_adv_bins <- cut(df_cost_mig$pcent_rot_adv, custom_bins)  

  bin_labs <- levels(df_cost$rot_adv_bins)
        
  #gg_nocost_nomig <- ggplot( df_nocost_nomig, aes(x=pcent_rot_adv)) + 
  gg_nocost_nomig <- ggplot( df_nocost_nomig, aes(x=rot_adv_bins)) + 
                 
             geom_bar() +
             #xlim(-20,400) +
             xlim(bin_labs) +
             xlab('') +
             ylab('count') +
             ggtitle('1. no resistance costs or dispersal') +
             #scale_y_sqrt(breaks=c(0,10,20,50,200,500,2000,5000)) + 
             theme_minimal() +
             theme(panel.grid.minor.y=element_blank(),
                   axis.text.x=element_blank())

  
  gg_cost <- ggplot( df_cost, aes(x=rot_adv_bins)) + 
             
             geom_bar() +
             #geom_histogram(binwidth=10) +
             #xlim(-20,400) +
             xlab('') +
             ylab('count') +
             ggtitle('2. with costs') +
             #scale_y_sqrt(breaks=c(0,10,20,50,200,500,2000,5000)) + 
             #scale_x_continuous(breaks=c(-10,-1,0,1,20,100,400)) +
             scale_x_discrete( limits=bin_labs,
                               labels=c("-20 to -1", "-1 to 1", "1 to 20", "20 to 100", "100 to 500"))+
             theme_minimal() +
             theme(panel.grid.minor.y=element_blank(),
                   axis.text.x=element_blank())
  
  gg_mig <- ggplot( df_mig, aes(x=rot_adv_bins)) + 
             
             geom_bar() +
             xlim(bin_labs) +
             xlab('') +
             ylab('count') +
             ggtitle('3. with dispersal refugia') +
             theme_minimal() + 
             theme(panel.grid.minor.y=element_blank(),
                   axis.text.x=element_blank())

  #gg_cost_mig <- ggplot( df_cost_mig, aes(x=rot_minus_seq)) + 
  gg_cost_mig <- ggplot( df_cost_mig, aes(x=rot_adv_bins)) +  
    
             geom_bar() +
             xlab('Percent benefit of rotation over sequence') +
             ylab('count') +
             ggtitle('4. with costs and dispersal') +
             #scale_y_sqrt(breaks=c(0,10,20,50,200,500,2000,5000)) + 
             theme_minimal() +
             scale_x_discrete( limits=bin_labs,
                               labels=c("-20 to -1", "-1 to 1", "1 to 20", "20 to 100", "100 to 500"))+       
             theme(panel.grid.minor.y=element_blank())  
  
  grid.arrange(gg_nocost_nomig, gg_cost, gg_mig, gg_cost_mig, ncol=1)

```

\pagebreak

```{r Fig5, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.width=9, fig.show='hold', fig.align='center', fig.cap="Figure 5. Example of a model run where there is a substantial benefit of rotations over a sequence. For the sequence resistance thresholds are reached for all insecticides in a little over 100 generations or 10 years. For the rotation resistance levels for all insecticides are maintained well below resistance thresholds for the length of the simulation (500 generations or 50 years)."}
# ? are these run ids before or after the runs that don't reach thresholds have been removed ?
# seems OK that they are after other runs removed
#scenarios_to_plot <- c(624,2167,602,4028,5771)
scenarios_to_plot <- c(2167)

for(scenario in scenarios_to_plot)
{
  #cat(scenario,"\n")
  
  linputs <- as.list( df_cost[scenario, 1:15] )
  
  # run one scenario
  dfres <- do.call(run_rot, linputs)
  
  ggrot <- rot_plot_resistance(dfres, plot_refuge=FALSE, logy=TRUE, plot=FALSE)
   
  #now run as sequence
  linputs$rot_interval <- 0
  dfres <- do.call(run_rot, linputs)
  
  ggseq <- rot_plot_resistance(dfres, plot_refuge=FALSE, logy=TRUE, plot=FALSE) 
  
  grid.arrange(ggrot, ggseq, ncol=1)
  
}

```

\pagebreak

```{r Fig6, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.width=9, fig.show='hold', fig.align='center', fig.cap="Figure 6. Which model inputs have the greatest influence on the difference between rotations and sequences ? In this case for scenario 2 where resistance costs are included but dispersal is not. Measured using Partial Rank Correlation Coefficients (PRCC). Positive values indicate a positive influence on the benefit of rotations, only cost and dominance of cost in this case. Dominance of cost and dominance of selection have the greatest magnitude of influence."}
  
library(sensitivity)
  
# pcc(X, y, rank = FALSE, nboot = 0, conf = 0.95)
# 
# Arguments
# X a data frame containing model input variables
# y a vector containing the responses 
# rank logical. If TRUE, the analysis is done on the ranks.
# nboot the number of bootstrap replicates.
# conf the confidence level of the bootstrap confidence intervals.

#same as above
in_cols <- c('cost','dom_cos','dom_sel','rr','expo_hi','male_expo_prop','eff','start_freqs')

    
    x <- df_cost[,in_cols]
    #y <- df_cost['rot_minus_seq']
    y <- df_cost['pcent_rot_adv']
          
    pcc_res <- pcc(x, y, rank=TRUE)
    
    #if you add bootstrap, error bars are added to the default plot & extra columns to the PRCC object
    #pcc_res <- pcc(x, y, rank=TRUE, nboot=100)
    #plot(pcc_res)
    
    #results are here I can probably rbind them together into a df that I can ggplot
    #pcc_res$PRCC
    
    to_plot <- pcc_res$PRCC
    #rename column 1 from 'original to PRCC
    names(to_plot)[1] <- 'PRCC'
    to_plot$inputs <- rownames(to_plot)  
    
    axis_text_x <- element_text(angle = 45,hjust = 1, vjust = 1)
    height <- 0.9
    
    gg <- ggplot( to_plot, aes_string(x='inputs',y='PRCC') ) +     
             geom_point(shape=1, colour='red') +
             theme(axis.text.x = axis_text_x) +
             geom_hline(yintercept = 0, linetype=3) +
             #theme(panel.grid.major.y = element_line(color = "grey", size = 1)) +
             ylim(-1,1) +
             #ggtitle(paste(strat_name[strategy_num])) +
             xlab(NULL) 

    plot(gg)

  #to put back in some ref gridlines that are removed by cowplot
  #theme_set(theme_gray())
  #theme_set(theme_bw())
  
  #plot_grid( plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],ncol=1, rel_heights=c(1,1,1,1.8))  
  #plot_grid( plotlist[[1]],plotlist[[2]],plotlist[[3]],ncol=1, rel_heights=c(1,1,1.6), labels='AUTO')    

```

\pagebreak

```{r Fig7, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.width=9, fig.show='hold', fig.align='center', fig.cap="Figure 7. Model runs in which rotations perform more than 20% better than sequences are associated with high dominance of cost and low dominance of selection. Dominance inputs are shown on the x and y axes. Small grey points indicate all model runs. Model runs in which rotations last greater than 20% longer than sequences are shown in colour with darker blue indicating those that have the greatest difference."}

#'cost','dom_cos','dom_sel','rr','expo_hi','male_expo_prop','eff','start_freqs'
#'cost','dom_cos','dom_sel'

y <- 'pcent_rot_adv'  

gg <- ggplot(df_cost, aes(x=dom_sel, y=dom_cos)) + 
     geom_point(shape='.', size=1, alpha=0.2, show.legend=FALSE) +
     theme_minimal() +
     #geom_point(data=filter(df_cost, pcent_rot_adv >= 20 ), shape=1, size=1, col='red', alpha=0.8)
     #shape=19 filled circle, 1=open circle
     geom_point(data=filter(df_cost, pcent_rot_adv >= 20), aes(col=pcent_rot_adv), shape=19, size=1, alpha=0.9) +
     viridis::scale_color_viridis(direction=-1) #discrete = TRUE)

plot(gg)

```

\pagebreak

```{r FigX, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5, fig.width=7.5, fig.show='hold', fig.align='left', fig.cap="Figure X. [todo need to modify caption from MJ paper, start by saying that only in left panel during application of the insecticide] The effect of model inputs on the fitness of genotypes for a single insecticide. Fitness is shown on the y-axis and the different genotypes (SS, SR, RR) on the x axis. Firstly the exposure input determines the proportion of the population in the left and right panels (exposed and not exposed). For those that are exposed (left panel) insecticide effectiveness sets the fitness for SS, resistance restoration 'restores' a portion of the fitness for RR and dominance of resistance determines how the fitness for SR lies between that of SS and RR. For those that are not exposed, fitness of SS is set to 1 by definition, resistance cost determines the fitness of RR and again dominance of cost determines how the fitness for SR sits between that of SS and RR. In this example effectiveness=0.8, resistance restoration=0.5 which 'restores' half of the fitness lost due to the insecticide, dominance of resistance=0.7 which sets the fitness of the SR closer to RR than SS. Resistance cost=0.3 which reduces fitness in the absence of the insecticide from 1 to 0.7, and dominance of cost=0.8 which sets fitness of SR close to RR."}
 
library(resistance) 
plot_fit_calc( effectiveness=0.8, resistance_restoration=0.5, dominance_restoration=0.7, dominance_cost=0.7, cost=0.3 )

```

\pagebreak
  
## References
<!-- now auto created here-->
