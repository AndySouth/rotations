---
title: "sensi_an_rotations201911. To analyse rotation runs for paper"
output: pdf_document
#output: word_document
author: "Andy South, Sam Jones and Ian Hastings"
date: "`r Sys.Date()`"
---


Code to plot and analyse rotations runs for paper.    

Runs themselves are done from rotation_runs2019.Rmd.    

16 expts of 10,000 runs each comparing rotations and sequences.

Code below will need to be adapted to work on all 16 experiments, so far it just works on one.



```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
  library(rotations)
  library(ggplot2)
  library(gridExtra)
  library(tidyverse)

  # where the rotation runs saved
  #infolder <- "C:\\Dropbox\\resistanceResults\\rotations\\"
  infolder <- "C:\\Dropbox\\2017_Rotations for IRM\\SJ_Runs_Nov\\"
  
```



```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=9, fig.height=11, comment=NA}

# sam is running all 16 scenarios with a single outfile
# but in the meantime can I read the rda's in individually ?
# e.g. need to be able to find files named like this
# 2019-11-05-10-42-df_res_all_rotA210000.rda
# how to get all combinations of A-D and 1-4
id_columns <- expand.grid(c("A","B","C","D"),c(1:4))
expt_ids <- paste0(id_columns[,1], id_columns[,2])
#i think that if I add the 10000 in I can find the unique files
expt_ids <- paste0(expt_ids,10000)

#list all files
#list.files(infolder)

#list files matching a pattern, now get just on matching each
#list.files(infolder,"A110000")

df_res_16 <- data.frame(stringsAsFactors=FALSE)

# read in all 16 files, rbind and add ID columns
for(i in 1:length(expt_ids))
{
  
  # gets loaded as df_res_all because that is what it was saved as
  load(paste0(infolder, list.files(infolder, expt_ids[i])))
  # add experiment ids, first as separate columns to make facetting easier maybe
  df_res_all$idAD <- substr(expt_ids[i],1,1)
  df_res_all$id14 <- substr(expt_ids[i],2,2)
  
  df_res_16 <- rbind(df_res_16, df_res_all)
    
}

save(df_res_16, file=paste0(infolder,'df_res_16.rda'))

```



# difference between rotations and sequences, all runs

```{r fig-si-1-abs-diff-rot-seq, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


#GOOD setting colours so can see easier when rot or seq better

widthbin <- 10 #either 10 or 20 looks fairly similar

# df_res_all$best_strategy <- ifelse(df_res_all$rot_minus_seq <= -(widthbin/2),"sequence", ifelse(df_res_all$rot_minus_seq > (widthbin/2), "rotation", "no_difference"))
# 
# ggplot(df_res_all, aes(x=rot_minus_seq, fill=best_strategy)) + 
#      geom_histogram(binwidth=widthbin, colour='white') + 
#      theme_minimal() +
#      theme(panel.grid.minor.y=element_blank())

# calc percentage difference between rotation and sequence
df_res_16$rms_percent <- 100 * df_res_16$rot_minus_seq / df_res_16$gens_seq

# best strategy calculation
# no_difference set to +/- half of widthbin set above
df_res_16$best_strategy <- ifelse(df_res_16$rot_minus_seq <= -(widthbin/2),"sequence", ifelse(df_res_16$rot_minus_seq > (widthbin/2), "rotation", "no_difference"))

# OR use a % threshold for strategies to be the same
# still uses widthbin which now represents a pcent
# no_difference set to +/- half of widthbin% set above
df_res_16$best_strategy <- ifelse(df_res_16$rms_percent <= -(widthbin/2),"sequence", ifelse(df_res_16$rms_percent > (widthbin/2), "rotation", "no_difference"))



# lengthening facet labels
# idAD_lookup <- c(
#   A = "A freq i-same",
#   B = "B freq i-diff",
#   C = "C mort i-same",
#   D = "B mort i-diff"
# )
# id14_lookup <- c(
#   "1" = "1 nocost nodisp",
#   "2" = "2 costs nodisp",
#   "3" = "3 nocost disp",
#   "4" = "4 costs disp"
# )

idAD_lookup <- c(
  A = "A frequency switch\n insecticides same",
  B = "B frequency switch\n insecticides different",
  C = "C mortality switch\n insecticides same",
  D = "D mortality switch\n insecticides different"
)

id14_lookup <- c(
  "1" = "1 no fit. costs\n no dispersal",
  "2" = "2 fit. costs\n no dispersal",
  "3" = "3 no fit. costs\n dispersal",
  "4" = "4 fit. costs and\n dispersal"
)

#colrs <- c("no_difference"=rgb(210,210,210,max=255),"rotation"=rgb(113,166,89,max=255),"sequence"=rgb(137,117,202,max=255))
colrs <- c("no_difference"=rgb(255,255,255,max=255),"rotation"=rgb(2,98,215,max=255),"sequence"=rgb(227,0,169,max=255))


#rot_minus_seq, facet by A-D and 1-4, better facet labels
ggplot(df_res_16, aes(x=rot_minus_seq, fill=best_strategy)) + 
     geom_histogram(binwidth=widthbin, colour='darkgrey') + 
     scale_fill_manual(values=colrs) +
     theme_minimal() +
     xlim(-100,100) +
     xlab("advantage of rotations over sequence in generations") +
     theme(panel.grid.minor.y=element_blank()) +
     facet_grid(rows=vars(id14), cols=vars(idAD),
                labeller=labeller(idAD=idAD_lookup, id14=id14_lookup))

#tally
#df_res_16 %>% group_by(id12) %>% tally()

```


# pcent difference between rotations and sequences, all runs

```{r fig1-pcent-diff-rot-seq, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}



#rms (rot_minus_seq)_pcent, facet by A-D and 1-4, better facet labels
ggplot(df_res_16, aes(x=rms_percent, fill=best_strategy)) + 
     geom_histogram(binwidth=widthbin, colour='darkgrey') + 
     scale_fill_manual(values=colrs) +
     theme_minimal() +
     #xlim(-100,100) +
     scale_x_continuous(limits=c(-80,80), breaks = c(-60,-40,-20,0,20,40,60)) +
     xlab("percentage advantage of rotations over sequence in generations") +
     theme(panel.grid.minor=element_blank()) +
     facet_grid(rows=vars(id14), cols=vars(idAD),
                labeller=labeller(idAD=idAD_lookup, id14=id14_lookup))

#just as a test
#can I plot gens_seq and gens_rot in same facet
#but I need to make data longer to do that, currently in same columns

```


# at each generations below threshold for rotations, which strategy was best

```{r fig2-which-best-each-gens-rot, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

#oooo this is interesting
#it shows what gens_rot the best strategies occur at
ggplot(df_res_16, aes(x=gens_rot, fill=best_strategy)) + 
     geom_histogram(binwidth=widthbin, colour='darkgrey') + 
     scale_fill_manual(values=colrs) +
     theme_minimal() +
     #xlim(-100,100) +
     xlab("generations to reach thresholds for ROTATION") +
     theme(panel.grid.minor.y=element_blank()) +
     facet_grid(rows=vars(id14), cols=vars(idAD),
                labeller=labeller(idAD=idAD_lookup, id14=id14_lookup))

```


# at each generations below threshold for rotations, which strategy was best

```{r fig3-which-best-each-gens-seq, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

#gens_seq the best strategies occur at
ggplot(df_res_16, aes(x=gens_seq, fill=best_strategy)) + 
     geom_histogram(binwidth=widthbin, colour='darkgrey') + 
     scale_fill_manual(values=colrs) +
     theme_minimal() +
     #xlim(-100,100) +
     xlab("generations to reach thresholds for SEQUENCE") +
     theme(panel.grid.minor.y=element_blank()) +
     facet_grid(rows=vars(id14), cols=vars(idAD),
                labeller=labeller(idAD=idAD_lookup, id14=id14_lookup))


```

\pagebreak


# proportion of scenarios not reaching resistance thresholds

```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# check proportion of scenarios not reaching thresholds by max_runs for both seq & rot
    
    nruns_fail <- df_res_16 %>% 
                  filter(gens_seq == max_gen & gens_rot == max_gen) %>%
                  summarise(n=n()) %>% 
                  unlist()
    
    cat('proportion runs not reaching thresholds : ', nruns_fail/nrow(df_res_16) ) 
    
    # remove runs where thresholds not reached for seq & rot 
    df_res_16 <- df_res_16 %>% 
                  filter(gens_seq != max_gen | gens_rot != max_gen) 
    

    nruns_same <- df_res_16 %>% 
                  filter(gens_seq == gens_rot) %>%
                  summarise(n=n()) %>% 
                  unlist()
    
    cat('proportion runs (that did reach threshold) where rotations and sequence the same  : ', nruns_same/nrow(df_res_16) )  
    
    
    nruns_rot_20pc_better <- df_res_16 %>% 
                  filter(rot_minus_seq/gens_seq >= 0.2 ) %>%
                  summarise(n=n()) %>% 
                  unlist()
    
    cat('proportion runs (that did reach threshold) where rotations >20 % better than sequence  : ', nruns_rot_20pc_better/nrow(df_res_16) )   
    
```

# Examples of runs where rotations > 20% better than sequences

```{r, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=9, fig.height=3.5}
#eval false because smaller runs don't have these
#TODO change which runs to show as examples

scenarios_to_plot <- c(624,2167,602,4028,5771)

for(scenario in scenarios_to_plot)
{
  cat(scenario,"\n")
  
  linputs <- as.list( df_res_all[scenario, 1:15] )
  
  # run one scenario
  dfres <- do.call(run_rot, linputs)
  
  rot_plot_resistance(dfres, plot_refuge=FALSE, logy=FALSE, plot=TRUE)
   
  #now run as sequence
  linputs$rot_interval <- 0
  dfres <- do.call(run_rot, linputs)
  
  rot_plot_resistance(dfres, plot_refuge=FALSE, logy=FALSE, plot=TRUE) 
  
  
  dfi <- data.frame(t(as.data.frame(linputs)))
  names(dfi) <- 'value'
  dfi$inputs <- rownames(dfi)

  #take out columns not between 0 & 1
  dfi <- filter(dfi, !inputs %in% c('max_gen','rot_interval','n_insecticides','plot','min_rwr_interval'))
  #also remove coverage & migration both set to 0 for now
  dfi <- filter(dfi, !inputs %in% c('coverage','migration'))
    
  ggins <- ggplot(dfi, aes(x=inputs,y=value)) + 
            geom_point() +
            theme_minimal() +
            ylim(0,1) +
            theme(axis.text.x = element_text(angle = 20,hjust = 1, vjust = 1))
  plot(ggins)
  
}



```


#Plots of how the difference between rotations and sequences respond to model inputs.

```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=9, fig.height=5}

# go through selected inputs and plot them on x with rot_minus_seq on y 
# TODO check whether this covers all the inputs we want to look at
in_cols <- c('cost','dom_cos','dom_sel','rr','expo_hi','male_expo_prop','eff','start_freqs')

y <- 'rot_minus_seq'  

for(i in in_cols)
{
    
    #plotnum <- plotnum + 1
    
    #print( ggplot(ggInsOuts, aes_string(x=i, y=y, colour="strategy")) + 
    #plotlist[[plotnum]] <- 
    print( ggplot(df_res_16, aes_string(x=i, y=y)) + 
             
             geom_point(shape=1, size=1, alpha=0.5, show.legend=FALSE) +
             theme_minimal() +
             geom_smooth(linetype='dashed',size=0.5) )
             
}

```

# PRCC to show the sensitivity of the difference between rotation and sequence to inputs
# this can only be used for the experiments where all insecticides are the same
# (because in the ones where insecticides differ there are multiple values for each input)

```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


  library(sensitivity)
  
# pcc(X, y, rank = FALSE, nboot = 0, conf = 0.95)
# 
# Arguments
# X a data frame containing model input variables
# y a vector containing the responses 
# rank logical. If TRUE, the analysis is done on the ranks.
# nboot the number of bootstrap replicates.
# conf the confidence level of the bootstrap confidence intervals.

#same as above
#TODO check that this covers all the inputs we want to look at
in_cols <- c('cost','dom_cos','dom_sel','rr','expo_hi','male_expo_prop','eff','start_freqs')

    
    x <- df_res_16[,in_cols]
    y <- df_res_16['rot_minus_seq']
      
    pcc_res <- pcc(x, y, rank=TRUE)
    
    #if you add bootstrap, error bars are added to the default plot & extra columns to the PRCC object
    #pcc_res <- pcc(x, y, rank=TRUE, nboot=100)
    #plot(pcc_res)
    
    #results are here I can probably rbind them together into a df that I can ggplot
    #pcc_res$PRCC
    
    to_plot <- pcc_res$PRCC
    #rename column 1 from 'original to PRCC
    names(to_plot)[1] <- 'PRCC'
    to_plot$inputs <- rownames(to_plot)  
    
    axis_text_x <- element_text(angle = 45,hjust = 1, vjust = 1)
    height <- 0.9
    
    gg <- ggplot( to_plot, aes_string(x='inputs',y='PRCC') ) +     
             geom_point(shape=1, colour='red') +
             theme(axis.text.x = axis_text_x) +
             geom_hline(yintercept = 0, linetype=3) +
             #theme(panel.grid.major.y = element_line(color = "grey", size = 1)) +
             ylim(-1,1) +
             #ggtitle(paste(strat_name[strategy_num])) +
             xlab(NULL) 

    plot(gg)

  #to put back in some ref gridlines that are removed by cowplot
  #theme_set(theme_gray())
  #theme_set(theme_bw())
  
  #plot_grid( plotlist[[1]],plotlist[[2]],plotlist[[3]],plotlist[[4]],ncol=1, rel_heights=c(1,1,1,1.8))  
  #plot_grid( plotlist[[1]],plotlist[[2]],plotlist[[3]],ncol=1, rel_heights=c(1,1,1.6), labels='AUTO')    


```

# Runs where rotations are >20% better (in red) are associated with higher dominance of cost and lower dominance of selection, but doesn't guarantee, must be interaction with other inputs too.
# this was for earlier runs when there was some strange model behaviour, may not be the case now
# and may not be very meaningful anyway

```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=9, fig.height=5}


#'cost','dom_cos','dom_sel','rr','expo_hi','male_expo_prop','eff','start_freqs'

#'cost','dom_cos','dom_sel'

y <- 'rot_minus_seq'  

ggplot(df_res_16, aes(x=dom_sel, y=dom_cos)) + 
     geom_point(shape=3, size=1, alpha=0.2, show.legend=FALSE) +
     theme_minimal() +
     geom_point(data=filter(df_res_16, rot_minus_seq/gens_seq >= 0.3 ), shape=1, size=1, col='red', alpha=0.8)



```



```{r, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.width=9, fig.height=6}
#eval=FALSE tmp because changes above will break this
# summary plot of all runs, would show any differences between sequence & rotations as non horizontal lines

# want to plot line between sequence and rotation value
# any deviation from horizontal will be obvious
# could use rotation interval as the x axis, so that longer intervals will be clearer

# maybe not for publication
# but useful for quick view

#it was useful for me but now that I've moved to one row per scenario it won't work !!

    gg <- ggplot( df_res_16, aes_string(x='rot_interval',
                                         y='tot_gens_dep_under50',
                                         group='scenario',
                                         colour='scenario') ) +
          geom_line( alpha=0.5, lwd=1 )

    plot(gg)
    
             
# plot gens againts exposure and effectiveness
# as a quick test to see if I can set the starting values of these higher
    
    gg <- ggplot( df_res_16, aes_string(x='eff',
                                         y='tot_gens_dep_under50') ) +
          geom_point( alpha=0.5 )
    plot(gg)    
       
    gg <- ggplot( df_res_16, aes_string(x='expo_hi',
                                         y='tot_gens_dep_under50') ) +
          geom_point( alpha=0.5 )
    plot(gg)    
    
    gg <- ggplot( df_res_16, aes_string(x='expo_hi*eff*male_expo_prop',
                                         y='tot_gens_dep_under50') ) +
          geom_point( alpha=0.5 )
    plot(gg)    
    

```  


