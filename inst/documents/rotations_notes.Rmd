#rotations_notes.Rmd

Just rough notes.

*4/10/2017*
  
How to make the dataframe that saves results in run_rot flexible to the number of insecticides ?

df_results <- data.frame(generation=1:max_gen,
                         insecticide=NA,
                         r1_active=NA,
                         r1_refuge=NA,
                         r2_active=NA,
                         r2_refuge=NA,
                         r3_active=NA,
                         r3_refuge=NA,
                         r4_active=NA,
                         r4_refuge=NA, stringsAsFactors = FALSE)

Can I adapt this from array_named() in resistance ?
#' n_insecticides <- 3
#' # list(c()) is important below to create one list for each dim
#' l_dimnames <- rep(list(c('no','lo','hi')), n_insecticides)
#' names(l_dimnames) <- paste0("niche", 1:n_insecticides)
#' do.call(array_named,l_dimnames)

# this feels hacky, but it does work & I can put in a function

# create the flexible r* columns
n_insecticides <- 3
l_ <- rep(list(NA), n_insecticides*2) #2 because active & refuge 
names(l_) <- c( paste0("r", 1:n_insecticides, "_active"),
                paste0("r", 1:n_insecticides, "_refuge") )
df_r <- do.call(data.frame,l_)

# create inflexible columns ready to add r* columns on
max_gen <- 10
df_results <- data.frame(generation=1:max_gen,
                         insecticide=NA)

df_results <- data.frame(df_results, df_r)

Note this can only cope with one insceticide being active at a time ? (I could put a comma delimited string in later if I did want to record multiple insecticides).

Does this fit with tidy data ?

Each variable you measure should be in one column.
Each different observation of that variable should be in a different row.

Yes I think it does. Although maybe not ?
Currently I record df_results and gather to df_r2 to allow plotting.
To get :
 generation insecticide    region  resistance
1          1          NA   r1_refuge 0.001000000
2          2           1   r1_refuge 0.001061247

So perhaps I can just save as that to start ? It has multiple rows per generation.
More difficult to see, but easier to plot ?

This allows me to facet by region.
BUT if I wanted to put the lines for active & region into the same subplots (which would make easier to view) I would probably want columns for active and refuge or would I ??

gen active_insecticide resistance_gene active_or_refuge resistance 

I can use tidyr::separate() to get from r1_refuge to r1 & refuge in different columns.

separate(region, into=c("resistance_gene","active_or_refuge"))

I now have run_rot() working for flexible numbers of insecticides (1-5).

done : Next, get active and refuge onto the same plots.  
done : allowed starting frequencies to be set

implemented set_expsoure_rot() now working
dfr <- run_rot(rot_interval=50, expo_hi=0.9)
dfr <- run_rot(rot_interval=50, expo_hi=0.2)
# diff frequency curves for r1 & r2
dfr <- run_rot(n=2, rot_interval=50, expo_hi=c(1,0.1))

started fitness_single_locus() from run_rot()

dfr <- run_rot(n=2, rot_interval=50, eff=c(1,0.1))

*9/10/17*
~ started first shiny UI : rotresist1
~ add rot interval and generations to rotresist
~ looking good


*10/10/17*

~ seems that resistance evolves more slowly in later insecticides despite same params. Why ?

~ aha! the new UI helped me to see that this can be a result of the decline in resistance frequency for the later insecticides when they are not being used at the start. e.g.

run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.1 , rot_interval = 50 , eff = 0.6 , dom = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration_rate_intervention = 0.01 , cost = 0.1 )

When cost is set to 0 all 3 insecticides give the same curves :

run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.1 , rot_interval = 50 , eff = 0.6 , dom = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration_rate_intervention = 0.01 , cost = 0 )

done ~ in plots change r1 to insecticide_1 etc.
done ~ in plots add the deployment symbol to legend

done ~ can I offer option to have plots on log y axis to make it clearer whats going on at lower frequencies ?

Now from the UI ticking log y axis influences the next plot, (but is isolated so allows you to compare log & non log plots).

Starting to think about sensitivity analysis.
For Levick et al the inputs and ranges were hardcoded into resistance::sensiAnPaperPart()

start_freq |    0.0001 - 0.1 log uniform
exposure |      0.1 - 0.9
male_exposure | 0 - 1
effectiveness | 0.3 - 1
dominance     | 0 - 1
rr_restoration |  0.2 - 1
correct_mix   | 0.5 - 1


For rotations 

n_insecticides    | 3,4,5
max_gen   | 
rot_interval | 5 - 50 (integer)
male_expo_prop    | 0 - 1
coverage          | 0.1 - 0.9
migration         |  
cost              | 0 - 0.05

dominance of selection  |
dominance of cost       | 0 - 1

Sudo manuscript rotations are always a single generation.

How do we deal with the problem that resistance frequenciesin the rotation scenario may go above 50% and this makes time-to-resistance not a good measure of how good the intervention is (because the rotation).

Ian wants it to be a fair comparison.

I'm nervous about making the rotation responsive. We both said that i unlikely to happen in the field.

Could we have number of generations at < 50% ? Not perfect either.

~ setting dominance of cost and dominance of selection to be different in fitness_single_locus().

*31/10/17*

UI :
Warning: Error in run_rot: argument 6 matches multiple formal arguments

probably due to recent splitting of dominance

Yes, fixed now.

Increasing dominance of cost decreases resistance, 
increasing dominance of selection increases resistance. (both as expected)

Ians document : manuscript notes.doc

We will compare 4 strategies
•	RwR (rotate when resistant.. really a sequential use policy but the term RwR emphasises that can return to insecticides used earlier in the sequence if they are now effective
•	Periodically rotate every 10 generations (provided there replacement insecticide has resistance levels below the threshold. 10 generations is about every year
•	Rotate every 20 generations (~ 2 years)
•	Rotate every 50 generations (~ 5 years).

Threshold for a policy change: resistance allele frequency > 50% (may also want to investigate a lower level e.g. 25% and/or a fitness criterion)

End of policy life: when resistance levels to all insecticides exceed the threshold for policy change.

Sensitivity analysis to test which of the policies is best will explore the parameter space defined on table 1. However, there are a few test cases we will examine first to test our understanding and illustrate the basic principles.


Test 1. No refugia (i.e. Coverage=100%) or fitness costs.
Would expect all policies to be equivalent.

Test 2. Dominance of resistance and fitness costs both set to 0.5.
I suspect one of the advantages of rotations (and the presence of refugia) is that they maintain lower resistance allele frequencies which slows the spread of recessive resistance alleles. I suspect/guess/intuit that if we make them semi-dominate these effects should disappear and all policies should be the same. I’m probably wrong but it’s a nice test…..

Things still to consider
RAF can go below the original defined level  due to natural selection…de we want to stop this e.g. by saying this minimum value is mutation/selection

What should we do about planned rotations where RAF>50% for several generation i.e. is an ineffective deployment. This gives it an ‘unfair’ advantage over RwR

We still need to set a trap so can’t rotate on the basis of a few generations e.g. every 2 gens indefinitely as selection brings RAF>0.5 and natural selection brings RAF<50%

Notes:
List of research questions (draft keep adding)

•	What are the relative impacts of fitness costs and size of refugia. Presumably we find lifespan of policy then do PRC (partial rank correlation) to quantify their impact.

•	Routine rotation may be better than a “rotate-when-resistant” (RwR) policy if resistance is recessive i.e. rapid rotation ensures resistance allele frequency in treated populations remains so low that resistant homozygotes are rare.

•	Can contrast to mixtures. Would have to use the full model for mixtures and this one for rotation. Unfortunately, we can’t have a separate refugia in the full model at present but will build this when simulating macro-mosaics. Once that is done we can use the full model for rotations so don’t need the simple model described here, although the algebra above may be faster than running the full model.

We are not necessarily recommending rotate when resistant (RwR) policy, but it serves a good baseline to compare reactive policies (such as RwR) with pro-active polices such as rotations.

RwR may be good if there is an exceptionally long lived insecticide in the armoury as will find and use it. If that long-lived insecticide is part of a rotation sequence, you may never find it (until it has outlasted all the others).

When RwR you know how many insecticides you have left. In a strict rotation, they may all start to exhibit resistance at roughly the same time with little fore-warning.

~ looking at fixing migration rate to be between 0 & 1, where 1 is random movement.

~~ currently suggestion is that it is set to (0.1-0.9)*(1- Coverage)

So I want to remove dependence on the 1-coverage bit, by putting that into the code.

migration_rate_intervention = 0.01, 

migration rate into and out-of the treated area. It is the proportion of the treated population that migrates. We assume that immigration=emigration.

First line of run_rot()

migration_rate_refugia = migration_rate_intervention * coverage/(1-coverage)  

This is done for all insecticides

     fem_intervention=
       (1-migration_rate_intervention)*RAF[temp_int, 'f', 'intervention', gen]+
       migration_rate_intervention*RAF[temp_int, 'f', 'refugia', gen]
      
     male_intervention=
       (1-migration_rate_intervention)*RAF[temp_int, 'm', 'intervention', gen]+
       migration_rate_intervention*RAF[temp_int, 'm', 'refugia', gen]
     
     fem_refugia=
       (1-migration_rate_refugia)*RAF[temp_int, 'f', 'refugia', gen]+
       migration_rate_refugia*RAF[temp_int, 'f', 'intervention', gen]
     
     male_refugia=
       (1-migration_rate_refugia)*RAF[temp_int, 'm', 'refugia', gen]+
       migration_rate_refugia*RAF[temp_int, 'm', 'intervention', gen]
     
    RAF[temp_int, 'f', 'intervention', gen]=fem_intervention
    RAF[temp_int, 'm', 'intervention', gen]=male_intervention 
    RAF[temp_int, 'f', 'refugia', gen]=fem_refugia
    RAF[temp_int, 'm', 'refugia', gen]=male_refugia

Perhaps I can put this into a little spreadsheet to test ?
Or into a little test function.
e.g. that when migration set to 1 mixing is random ?
Just for 1 gender.

coverage

migration_refugia = migration_intervention * coverage/(1-coverage)  

freq_new <- (1-migration)*

Nearly there, testing Ians migration :


Ah yes 1-c is max migration, it gives equal frequencies in one generation

> migration_test(migration=0.4, startfreqs=c(0.8,0.2), coverage = 0.6)
              gen
site             1    2    3    4    5    6    7    8    9   10
  intervention 0.8 0.56 0.56 0.56 0.56 0.56 0.56 0.56 0.56 0.56
  refugia      0.2 0.56 0.56 0.56 0.56 0.56 0.56 0.56 0.56 0.56

done ~ fix migration rate to be between 0 & 1, where 1 is random movement.

~ allowed plots not to show refuge

#high cost, no migration
run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.01 , rot_interval = 10 , eff = 1 , dom_sel = 0.5 , dom_cos = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration = 0 , cost = 0.1 , logy = FALSE )
#no cost, no migration
run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.01 , rot_interval = 10 , eff = 1 , dom_sel = 0.5 , dom_cos = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration = 0 , cost = 0 , logy = FALSE )
#no cost and rotate when resistant, no migration
run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.01 , rot_interval = 0 , eff = 1 , dom_sel = 0.5 , dom_cos = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration = 0 , cost = 0 , logy = FALSE )
#no cost, some migration
run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.01 , rot_interval = 10 , eff = 1 , dom_sel = 0.5 , dom_cos = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration = 0.05 , cost = 0 , logy = FALSE )

done ~ improve plot legend to show when insecticide in use

*20/11/17*

~ looking at refactoring the migration code in run_rot()

Can do this to get the allele frequencies for generation 2 (by )

RAF[,,,2]

~ currently it does 4 very similar calcs for m|f, refuge|active.

~ i can replace with single, except need to be acreful not to change values before they have been used in the other calculations.

FROM :
    for(temp_int in 1:n_insecticides){ 
        
     fem_intervention=
       (1-migration_rate_intervention)*RAF[temp_int, 'f', 'intervention', gen]+
       migration_rate_intervention*RAF[temp_int, 'f', 'refugia', gen]
      
     male_intervention=
       (1-migration_rate_intervention)*RAF[temp_int, 'm', 'intervention', gen]+
       migration_rate_intervention*RAF[temp_int, 'm', 'refugia', gen]
     
     fem_refugia=
       (1-migration_rate_refugia)*RAF[temp_int, 'f', 'refugia', gen]+
       migration_rate_refugia*RAF[temp_int, 'f', 'intervention', gen]
     
     male_refugia=
       (1-migration_rate_refugia)*RAF[temp_int, 'm', 'refugia', gen]+
       migration_rate_refugia*RAF[temp_int, 'm', 'intervention', gen]
     
    RAF[temp_int, 'f', 'intervention', gen]=fem_intervention
    RAF[temp_int, 'm', 'intervention', gen]=male_intervention 
    RAF[temp_int, 'f', 'refugia', gen]=fem_refugia
    RAF[temp_int, 'm', 'refugia', gen]=male_refugia
  
   }

TO :

    mig_intervention <- (1-migration_rate_intervention)*RAF[,, 'intervention', gen]+
                           migration_rate_intervention *RAF[,, 'refugia', gen]
    
    mig_refugia      <- (1-migration_rate_refugia)*RAF[,, 'refugia', gen]+
                           migration_rate_refugia *RAF[,, 'intervention', gen]
    
    RAF[,, 'intervention', gen] <- mig_intervention
    RAF[,, 'refugia', gen] <- mig_refugia

Which is more concise and shows more clearly what is going on.

# testing multiplying RAF arrays
# to allow making code more concise

RAF <- set_start_freqs(n=3, max_gen = 1, freqs=c(0.1,0.01,0.001))
RAF2 <- set_start_freqs(n=3, max_gen = 1, freqs=c(1,2,3))

RAF * RAF2
           sex
insecticide     m     f
          1 0.100 0.100
          2 0.020 0.020
          3 0.003 0.003

done ~ put migration code into a function 
started ~ add a test that checks migration for diff insecticides & mf

~ rdpeng suggests not having non standard evaluation in package code :
If you have any non-standard evaluation in your package code (which you’ll notice because of the “no visible bindings” warnings you’ll get when you check the package), go through and change any instances to use standard evaluation alternatives. This change prevents these warnings when you check your package and will also ensure that the functions behave like you expect them to when they are run by other users in their own R sessions.
~ https://bookdown.org/rdpeng/RProgDA/non-standard-evaluation.html

# programing with dplyr
http://dplyr.tidyverse.org/articles/programming.html


*21/11/17*
~ is it worth creating a get_freq() or getraf() function similar to in rtsetse but not as complex ?
~ pass RAF
~ get_freq(insecticide=1, site='intervention', sex='f', gen=2 )
~ assume all for any not specified
~ have an as_df arg to return as a dataframe

ARG! got migration seeming like it's working

BUT now have come across non-standard-evaluation error in run_rot()

Fix this :
Error in filter(., active_or_refuge == "active") : 
  object 'active_or_refuge' not found
  
Draft that is sposed to help explain :
http://rpubs.com/lionel-/programming-draft
and posts in here :
https://community.rstudio.com/t/should-tidyeval-be-abandoned/2238/37


I could remove the generations under 50 bit for now to try to get run_rot() working again.

removed add_gens_under50 and now run_rot() does run.

Ians text removed from the insecticide switching portion of code

  #NOTE. At the moment if all but one of the insecticides are over the threshold frequency, the one under the threshold
  #will be repeatedly deployed. For example, if there are 3 insecticides and rotation is every 10 generations. 
  #if #3 is being deployed and due to rotate out at generetion 100: if only #3 is under the threshold
  #it will not rotate out, but will continue to be used util the next scheduled rotation at which point
    #(a) it will continue to be use if it is the only one below the threshold 
    #(b) it will be replaced if one of the other insecticides is now below the threshold due to fitness effects or migration
    #(c) the simulation will terminate if all insecticides exceed the threshold

*22/11/17*
~ added sentence about interval 0 RwR to the UI

~ removed this commented out alternative to df_results
  #experimental
  # df_res_active <- data.frame(generation=rep(1:max_gen,n_insecticides),
  #                       insecticide=NA,
  #                       region=NA,
  #                       resistance=NA, stringsAsFactors = FALSE)
  # df_res_refuge <- df_res_active

~ take the insecticide switching out into its own function(s)
insecticide_check()
insecticide_switch()

~ rename rot_count to gens_this_insecticide



    



# check with Ian
~ insecticide switch criterion is female only

# TODO

~ add in an option to limit switch back to previous insecticides
~ could add something to put a lower limit on length of rotations

~ create a new version of run_rot2() allowing me to refactor the code and check that it still generates same results as run_rot() 

~ maybe have a set_raf() function too

~ get an online version up on shinyapps

~ sort outputs which need to be time to resistance for planned rotations and RwR rotate when resistant. Sequence.

~ time under resitance threshold, e.g. 50%


* rotations understand code better
* rotations add catch to stop freq declining
* rotate when resistant add catch to stop switch back to insecticide used < x years ago


~ Ian & I talked about using fitness to determine changes. and that fitness could be used as an index of population, but Ian was sceptical, he said to look up fitness determinants of population on wikipedia, about soft & hard selection.

~ Ian will send me grant app to assess single v multi locus insecticide resistance
~ Ian said we may want to put something in to stop Frequency going below initial starting value when not in use (because this could represent background balance between benefits & cost)



*Ian said first question is to assess whether there is any benefit to rotations when there are no costs and no emigration*

~ test fitness_single_locus() from run_rot() and add to Rmd


~ check in resistance::fitnessSingleLocus() on separation of dominance of cost & selection. Was probably OK for Levick et al because we didn't have cost in. 
But I think that dominance of cost may be set to 0 which means that the RS experiences no effect of cost.

    a_dom       <- array_named(locusNum=c(1,2), exposure=c('no','lo','hi')) 
    a_dom[1, 'hi'] <- dom1
    a_dom[2, 'hi'] <- dom2
    
    #exposure 0 'no'
    a_fitloc[ paste0('RS',locusNum), 'no'] <- 1 - (a_dom[locusNum, 'no'] * a_cost[locusNum])
    a_fitloc[ paste0('RR',locusNum), 'no'] <- 1 - a_cost[locusNum]


# state of play
~ rotations1.Rmd : example plots
~ UI : rotations/shiny/rotresist1/server.r

~ RAF[,,,2] to get allele frequencies for generation 2 (by insecticide,sex and active|refuge)



# funding opportunities
https://lstmed.sharepoint.com/research/RBPS/Pages/Funding%20Information/Funding-Opportunities.aspx     
https://www.researchprofessional.com/funding/simple?q=software#1509451534514
                         