#rotations_notes.Rmd

Just rough notes.

*4/10/2017*
  
How to make the dataframe that saves results in run_rot flexible to the number of insecticides ?

df_results <- data.frame(generation=1:max_gen,
                         insecticide=NA,
                         r1_active=NA,
                         r1_refuge=NA,
                         r2_active=NA,
                         r2_refuge=NA,
                         r3_active=NA,
                         r3_refuge=NA,
                         r4_active=NA,
                         r4_refuge=NA, stringsAsFactors = FALSE)

Can I adapt this from array_named() in resistance ?
#' n_insecticides <- 3
#' # list(c()) is important below to create one list for each dim
#' l_dimnames <- rep(list(c('no','lo','hi')), n_insecticides)
#' names(l_dimnames) <- paste0("niche", 1:n_insecticides)
#' do.call(array_named,l_dimnames)

# this feels hacky, but it does work & I can put in a function

# create the flexible r* columns
n_insecticides <- 3
l_ <- rep(list(NA), n_insecticides*2) #2 because active & refuge 
names(l_) <- c( paste0("r", 1:n_insecticides, "_active"),
                paste0("r", 1:n_insecticides, "_refuge") )
df_r <- do.call(data.frame,l_)

# create inflexible columns ready to add r* columns on
max_gen <- 10
df_results <- data.frame(generation=1:max_gen,
                         insecticide=NA)

df_results <- data.frame(df_results, df_r)

Note this can only cope with one insceticide being active at a time ? (I could put a comma delimited string in later if I did want to record multiple insecticides).

Does this fit with tidy data ?

Each variable you measure should be in one column.
Each different observation of that variable should be in a different row.

Yes I think it does. Although maybe not ?
Currently I record df_results and gather to df_r2 to allow plotting.
To get :
 generation insecticide    region  resistance
1          1          NA   r1_refuge 0.001000000
2          2           1   r1_refuge 0.001061247

So perhaps I can just save as that to start ? It has multiple rows per generation.
More difficult to see, but easier to plot ?

This allows me to facet by region.
BUT if I wanted to put the lines for active & region into the same subplots (which would make easier to view) I would probably want columns for active and refuge or would I ??

gen active_insecticide resistance_gene active_or_refuge resistance 

I can use tidyr::separate() to get from r1_refuge to r1 & refuge in different columns.

separate(region, into=c("resistance_gene","active_or_refuge"))

I now have run_rot() working for flexible numbers of insecticides (1-5).

done : Next, get active and refuge onto the same plots.  
done : allowed starting frequencies to be set

implemented set_expsoure_rot() now working
dfr <- run_rot(rot_interval=50, expo_hi=0.9)
dfr <- run_rot(rot_interval=50, expo_hi=0.2)
# diff frequency curves for r1 & r2
dfr <- run_rot(n=2, rot_interval=50, expo_hi=c(1,0.1))

started fitness_single_locus() from run_rot()

dfr <- run_rot(n=2, rot_interval=50, eff=c(1,0.1))

*9/10/17*
~ started first shiny UI : rotresist1
~ add rot interval and generations to rotresist
~ looking good


*10/10/17*

~ seems that resistance evolves more slowly in later insecticides despite same params. Why ?

~ aha! the new UI helped me to see that this can be a result of the decline in resistance frequency for the later insecticides when they are not being used at the start. e.g.

run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.1 , rot_interval = 50 , eff = 0.6 , dom = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration_rate_intervention = 0.01 , cost = 0.1 )

When cost is set to 0 all 3 insecticides give the same curves :

run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.1 , rot_interval = 50 , eff = 0.6 , dom = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration_rate_intervention = 0.01 , cost = 0 )

done ~ in plots change r1 to insecticide_1 etc.
done ~ in plots add the deployment symbol to legend

done ~ can I offer option to have plots on log y axis to make it clearer whats going on at lower frequencies ?

Now from the UI ticking log y axis influences the next plot, (but is isolated so allows you to compare log & non log plots).

Starting to think about sensitivity analysis.
For Levick et al the inputs and ranges were hardcoded into resistance::sensiAnPaperPart()

start_freq |    0.0001 - 0.1 log uniform
exposure |      0.1 - 0.9
male_exposure | 0 - 1
effectiveness | 0.3 - 1
dominance     | 0 - 1
rr_restoration |  0.2 - 1
correct_mix   | 0.5 - 1


For rotations 

n_insecticides    | 3,4,5
max_gen   | 
rot_interval | 5 - 50 (integer)
male_expo_prop    | 0 - 1
coverage          | 0.1 - 0.9
migration         |  
cost              | 0 - 0.05

dominance of selection  |
dominance of cost       | 0 - 1

Sudo manuscript rotations are always a single generation.

How do we deal with the problem that resistance frequenciesin the rotation scenario may go above 50% and this makes time-to-resistance not a good measure of how good the intervention is (because the rotation).

Ian wants it to be a fair comparison.

I'm nervous about making the rotation responsive. We both said that i unlikely to happen in the field.

Could we have number of generations at < 50% ? Not perfect either.

~ setting dominance of cost and dominance of selection to be different in fitness_single_locus().

*31/10/17*

UI :
Warning: Error in run_rot: argument 6 matches multiple formal arguments

probably due to recent splitting of dominance

Yes, fixed now.

Increasing dominance of cost decreases resistance, 
increasing dominance of selection increases resistance. (both as expected)

Ians document : manuscript notes.doc

We will compare 4 strategies
•	RwR (rotate when resistant.. really a sequential use policy but the term RwR emphasises that can return to insecticides used earlier in the sequence if they are now effective
•	Periodically rotate every 10 generations (provided there replacement insecticide has resistance levels below the threshold. 10 generations is about every year
•	Rotate every 20 generations (~ 2 years)
•	Rotate every 50 generations (~ 5 years).

Threshold for a policy change: resistance allele frequency > 50% (may also want to investigate a lower level e.g. 25% and/or a fitness criterion)

End of policy life: when resistance levels to all insecticides exceed the threshold for policy change.

Sensitivity analysis to test which of the policies is best will explore the parameter space defined on table 1. However, there are a few test cases we will examine first to test our understanding and illustrate the basic principles.


Test 1. No refugia (i.e. Coverage=100%) or fitness costs.
Would expect all policies to be equivalent.

Test 2. Dominance of resistance and fitness costs both set to 0.5.
I suspect one of the advantages of rotations (and the presence of refugia) is that they maintain lower resistance allele frequencies which slows the spread of recessive resistance alleles. I suspect/guess/intuit that if we make them semi-dominate these effects should disappear and all policies should be the same. I’m probably wrong but it’s a nice test…..

Things still to consider
RAF can go below the original defined level  due to natural selection…de we want to stop this e.g. by saying this minimum value is mutation/selection

What should we do about planned rotations where RAF>50% for several generation i.e. is an ineffective deployment. This gives it an ‘unfair’ advantage over RwR

We still need to set a trap so can’t rotate on the basis of a few generations e.g. every 2 gens indefinitely as selection brings RAF>0.5 and natural selection brings RAF<50%

Notes:
List of research questions (draft keep adding)

•	What are the relative impacts of fitness costs and size of refugia. Presumably we find lifespan of policy then do PRC (partial rank correlation) to quantify their impact.

•	Routine rotation may be better than a “rotate-when-resistant” (RwR) policy if resistance is recessive i.e. rapid rotation ensures resistance allele frequency in treated populations remains so low that resistant homozygotes are rare.

•	Can contrast to mixtures. Would have to use the full model for mixtures and this one for rotation. Unfortunately, we can’t have a separate refugia in the full model at present but will build this when simulating macro-mosaics. Once that is done we can use the full model for rotations so don’t need the simple model described here, although the algebra above may be faster than running the full model.

We are not necessarily recommending rotate when resistant (RwR) policy, but it serves a good baseline to compare reactive policies (such as RwR) with pro-active polices such as rotations.

RwR may be good if there is an exceptionally long lived insecticide in the armoury as will find and use it. If that long-lived insecticide is part of a rotation sequence, you may never find it (until it has outlasted all the others).

When RwR you know how many insecticides you have left. In a strict rotation, they may all start to exhibit resistance at roughly the same time with little fore-warning.

~ looking at fixing migration rate to be between 0 & 1, where 1 is random movement.

~~ currently suggestion is that it is set to (0.1-0.9)*(1- Coverage)

So I want to remove dependence on the 1-coverage bit, by putting that into the code.

migration_rate_intervention = 0.01, 

migration rate into and out-of the treated area. It is the proportion of the treated population that migrates. We assume that immigration=emigration.

First line of run_rot()

migration_rate_refugia = migration_rate_intervention * coverage/(1-coverage)  

This is done for all insecticides

     fem_intervention=
       (1-migration_rate_intervention)*RAF[temp_int, 'f', 'intervention', gen]+
       migration_rate_intervention*RAF[temp_int, 'f', 'refugia', gen]
      
     male_intervention=
       (1-migration_rate_intervention)*RAF[temp_int, 'm', 'intervention', gen]+
       migration_rate_intervention*RAF[temp_int, 'm', 'refugia', gen]
     
     fem_refugia=
       (1-migration_rate_refugia)*RAF[temp_int, 'f', 'refugia', gen]+
       migration_rate_refugia*RAF[temp_int, 'f', 'intervention', gen]
     
     male_refugia=
       (1-migration_rate_refugia)*RAF[temp_int, 'm', 'refugia', gen]+
       migration_rate_refugia*RAF[temp_int, 'm', 'intervention', gen]
     
    RAF[temp_int, 'f', 'intervention', gen]=fem_intervention
    RAF[temp_int, 'm', 'intervention', gen]=male_intervention 
    RAF[temp_int, 'f', 'refugia', gen]=fem_refugia
    RAF[temp_int, 'm', 'refugia', gen]=male_refugia

Perhaps I can put this into a little spreadsheet to test ?
Or into a little test function.
e.g. that when migration set to 1 mixing is random ?
Just for 1 gender.

coverage

migration_refugia = migration_intervention * coverage/(1-coverage)  

freq_new <- (1-migration)*

Nearly there, testing Ians migration :


Ah yes 1-c is max migration, it gives equal frequencies in one generation

> migration_test(migration=0.4, startfreqs=c(0.8,0.2), coverage = 0.6)
              gen
site             1    2    3    4    5    6    7    8    9   10
  intervention 0.8 0.56 0.56 0.56 0.56 0.56 0.56 0.56 0.56 0.56
  refugia      0.2 0.56 0.56 0.56 0.56 0.56 0.56 0.56 0.56 0.56

done ~ fix migration rate to be between 0 & 1, where 1 is random movement.

~ allowed plots not to show refuge

#high cost, no migration
run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.01 , rot_interval = 10 , eff = 1 , dom_sel = 0.5 , dom_cos = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration = 0 , cost = 0.1 , logy = FALSE )
#no cost, no migration
run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.01 , rot_interval = 10 , eff = 1 , dom_sel = 0.5 , dom_cos = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration = 0 , cost = 0 , logy = FALSE )
#no cost and rotate when resistant, no migration
run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.01 , rot_interval = 0 , eff = 1 , dom_sel = 0.5 , dom_cos = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration = 0 , cost = 0 , logy = FALSE )
#no cost, some migration
run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.01 , rot_interval = 10 , eff = 1 , dom_sel = 0.5 , dom_cos = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0.8 , migration = 0.05 , cost = 0 , logy = FALSE )

done ~ improve plot legend to show when insecticide in use

*20/11/17*

~ looking at refactoring the migration code in run_rot()

Can do this to get the allele frequencies for generation 2 (by )

RAF[,,,2]

~ currently it does 4 very similar calcs for m|f, refuge|active.

~ i can replace with single, except need to be acreful not to change values before they have been used in the other calculations.

FROM :
    for(temp_int in 1:n_insecticides){ 
        
     fem_intervention=
       (1-migration_rate_intervention)*RAF[temp_int, 'f', 'intervention', gen]+
       migration_rate_intervention*RAF[temp_int, 'f', 'refugia', gen]
      
     male_intervention=
       (1-migration_rate_intervention)*RAF[temp_int, 'm', 'intervention', gen]+
       migration_rate_intervention*RAF[temp_int, 'm', 'refugia', gen]
     
     fem_refugia=
       (1-migration_rate_refugia)*RAF[temp_int, 'f', 'refugia', gen]+
       migration_rate_refugia*RAF[temp_int, 'f', 'intervention', gen]
     
     male_refugia=
       (1-migration_rate_refugia)*RAF[temp_int, 'm', 'refugia', gen]+
       migration_rate_refugia*RAF[temp_int, 'm', 'intervention', gen]
     
    RAF[temp_int, 'f', 'intervention', gen]=fem_intervention
    RAF[temp_int, 'm', 'intervention', gen]=male_intervention 
    RAF[temp_int, 'f', 'refugia', gen]=fem_refugia
    RAF[temp_int, 'm', 'refugia', gen]=male_refugia
  
   }

TO :

    mig_intervention <- (1-migration_rate_intervention)*RAF[,, 'intervention', gen]+
                           migration_rate_intervention *RAF[,, 'refugia', gen]
    
    mig_refugia      <- (1-migration_rate_refugia)*RAF[,, 'refugia', gen]+
                           migration_rate_refugia *RAF[,, 'intervention', gen]
    
    RAF[,, 'intervention', gen] <- mig_intervention
    RAF[,, 'refugia', gen] <- mig_refugia

Which is more concise and shows more clearly what is going on.

# testing multiplying RAF arrays
# to allow making code more concise

RAF <- set_start_freqs(n=3, max_gen = 1, freqs=c(0.1,0.01,0.001))
RAF2 <- set_start_freqs(n=3, max_gen = 1, freqs=c(1,2,3))

RAF * RAF2
           sex
insecticide     m     f
          1 0.100 0.100
          2 0.020 0.020
          3 0.003 0.003

done ~ put migration code into a function 
started ~ add a test that checks migration for diff insecticides & mf

~ rdpeng suggests not having non standard evaluation in package code :
If you have any non-standard evaluation in your package code (which you’ll notice because of the “no visible bindings” warnings you’ll get when you check the package), go through and change any instances to use standard evaluation alternatives. This change prevents these warnings when you check your package and will also ensure that the functions behave like you expect them to when they are run by other users in their own R sessions.
~ https://bookdown.org/rdpeng/RProgDA/non-standard-evaluation.html

# programing with dplyr
http://dplyr.tidyverse.org/articles/programming.html


*21/11/17*
~ is it worth creating a get_freq() or getraf() function similar to in rtsetse but not as complex ?
~ pass RAF
~ get_freq(insecticide=1, site='intervention', sex='f', gen=2 )
~ assume all for any not specified
~ have an as_df arg to return as a dataframe

ARG! got migration seeming like it's working

BUT now have come across non-standard-evaluation error in run_rot()

Fix this :
Error in filter(., active_or_refuge == "active") : 
  object 'active_or_refuge' not found
  
Draft that is sposed to help explain :
http://rpubs.com/lionel-/programming-draft
and posts in here :
https://community.rstudio.com/t/should-tidyeval-be-abandoned/2238/37


I could remove the generations under 50 bit for now to try to get run_rot() working again.

removed add_gens_under50 and now run_rot() does run.

Ians text removed from the insecticide switching portion of code

  #NOTE. At the moment if all but one of the insecticides are over the threshold frequency, the one under the threshold
  #will be repeatedly deployed. For example, if there are 3 insecticides and rotation is every 10 generations. 
  #if #3 is being deployed and due to rotate out at generetion 100: if only #3 is under the threshold
  #it will not rotate out, but will continue to be used util the next scheduled rotation at which point
    #(a) it will continue to be use if it is the only one below the threshold 
    #(b) it will be replaced if one of the other insecticides is now below the threshold due to fitness effects or migration
    #(c) the simulation will terminate if all insecticides exceed the threshold

*22/11/17*
~ added sentence about interval 0 RwR to the UI

~ removed this commented out alternative to df_results
  #experimental
  # df_res_active <- data.frame(generation=rep(1:max_gen,n_insecticides),
  #                       insecticide=NA,
  #                       region=NA,
  #                       resistance=NA, stringsAsFactors = FALSE)
  # df_res_refuge <- df_res_active

~ take the insecticide switching out into its own function(s)
insecticide_check()
insecticide_switch()

~ rename rot_count to gens_this_insecticide

~ add in an option to limit switch back to previous insecticides
~ added something to put a lower limit on length of rotations for rwr

~ added option to stop resistance frequencies going below starting value (the thinking being that they could be maintained at this value by selection). It happens in the simulation when there is a cost and the insecticide is not in use.     

~ deployed to shinyapps : working well now
https://andysouth.shinyapps.io/rotresist1/

*23/11/17*
~ sent draft model-data gap workshop invite to IVCC

~ tweaked UI input defaults to show a comparison of fixed rotation versus sequence (rwr)

start protocol for sensitivity analysis. 

Currently run_rot() outputs :
'data.frame':	1600 obs. of  5 variables:
 $ generation      : int  1 2 3 4 5 6 7 8 9 10 ...
 $ insecticide     : num  NA 1 1 1 1 1 1 1 1 1 ...
 $ resist_gene     : chr  "insecticide1" "insecticide1" "insecticide1" "insecticide1" ...
 $ active_or_refuge: chr  "active" "active" "active" "active" ...
 $ resistance      : num  0.001 0.00141 0.002 0.00283 0.00399 ...
 
 insecticide : indicates which is in use
 resist_gene : which gene does this frequency relate to
 
 from run_rot() now commented out 
 
  # calculate number generations under 50% resistance 
  
  df_res2 <- df_res2 %>%
    dplyr::filter(active_or_refuge=='active') %>%
    group_by(resist_gene) %>%
    summarise(gens_under50 = sum(resistance < 0.5, na.rm=TRUE)) %>%
    ungroup() %>%
    left_join(df_res2, by='resist_gene')


tst <- run_rot()

tst %>%
dplyr::filter(active_or_refuge=='active') %>%
group_by(resist_gene) %>%
summarise(gens_under50 = sum(resistance < 0.5, na.rm=TRUE))

This gives generations under 50% resistance for each insecticide in the active area

1 insecticide1          134
2 insecticide2          144
3 insecticide3          154
4 insecticide4          164

I could then calculate the mean gens_under50 across all the insecticides.

tst %>%
dplyr::filter(active_or_refuge=='active') %>%
group_by(resist_gene) %>%
summarise(gens_under50 = sum(resistance < 0.5, na.rm=TRUE)) %>%
summarise(mean_gens_under50 = mean(gens_under50))

  mean_gens_under50
              <dbl>
1               149

Look back at the resistance sensitivity code and see how much of it I can use.

# resistance files to do runs
1. sensiAnPaper1All.Rmd : code to run whole sensitivity analysis & produce plots 
1. sensiAnPaperPart.r   : sets up param values and runs for one treatment (e.g. mixture, insecticide1)
1. setInputOneScenario.r: creates input object for each run
1. runModel2.r          : runs model for the passed scenarios

I would like to modify setInputOneScenario.r so I'm not referencing inputs by their location in the matrix which seems dangerous, but I might not be able to get around ?

Can I store the inputs in a dataframe with a name column, or with rownames ?
Or probably it should be a dataframe with a column name for each input, this will make it easy to add multiple runs together.

resistance::runModel2() just accepts an input matrix (i.e. not individually specified params) you need to call setInputOneScenario() first.
input <- setInputOneScenario()
listOut <- runModel2(input)

rotations::run_rot() does currently accept individually specified params

I want to make rotations reasonably similar to resistance but make improvements where I can.

I can possibly 
1. create a set_input_one_scenario() function that returns a dataframe (or list ?) of the inputs.
1. continue to allow run_rot() to accept individual inputs with an optional list

maybe a diff way of doing too using ... operator, if I have as a list can I pass directly without having to write them all out ?

in resistance this function passes all it's arguments onto another. 

resistSimple <- function(...)
{
  input <- setInputOneScenario(...)

can I create a list and then pass that to run_rot() (yes using do.call) and also save as a dataframe ?
This use of do.call given in Hadleys advanced R.

linputs <- list(max_gen = 50, n_insecticides = 2)
do.call(run_rot, linputs)
dfinputs <- as.data.frame(linputs)

This is good in that I don't have to specify all the inputs.
Also easy afterwards to rbind dfinputs together.

Can I make the rotations workflow with fewer files than the resistance one ? :
rotations workflow :
1. sensi_an_rotation1.Rmd : run whole sensi analysis including setting input ranges, & analysing outputs
1. run_rot.r              : a single model run

resistance workflow
1. sensiAnPaper1All.Rmd : code to run whole sensitivity analysis & produce plots 
1. sensiAnPaperPart.r   : sets up param values and runs for one treatment (e.g. mixture, insecticide1)
1. setInputOneScenario.r: creates input object for each run
1. runModel2.r          : runs model for the passed scenarios

But may make sense to keep closer to the resistance workflow.


*27/11/17*

~ talked to Ian fine to send out invite for IVCC workshop now
~ ask Hilary & Martin if they have any other staff that can come
~ do a doodle poll for dates

~ checked with Ian, fine that insecticide switch criterion is female only

#Q for Ian :
Is it mean generations under 50 for all insecticides that we want ?

#discussion
Probably just for the currently active insecticide. Might be called total effectively controlled generations.

but then how do we compare multiple insecticides.

We might also be interested in the other insecticides recovering.

So we might want more than one output.

Output1 : Total well controlled generations.
For each generation count whether the active insecticide is below the resistance threshold of 50%.

Output2 : (may not be as useful) Mean number of generations below resistance threshold across all insecticides at all times. 

Scenarios.


Ian not that keen on my minimum timespan for rotate-when-resistant, because that potentially forces continued use of an insecticide that is ineffective. He would rather that something that stops switching back to an insecticide which has been used less than e.g. 5 generations ago. But I asked whether testing for resistance is likely to be tht frequent ? If testing is only once per year than changes can perhaps only be made every 10 generations. 

We agreed that we could come back to this later, because it only really becomes relevant when there are fairly high costs that being resistance down when insecticides are not in use.

gens_dep_under50 : is the 
tot_gens_dep_under50 : summed across all insecticides

Good meeting with Rosemary about spray data.

*28/11/17*
Planning IVCC workshop.
potential dates :
8,9,11,12 and 29th January are best.

8th is a monday I'd like to miss.

2 hour or half day ? I'm inclined to 2 hours. More likely to get people.

Sent invite.

started a word doc with outline

Decisions to make before : 
~ Focus on mix v sequence, or rotations, or both

*29/11/17*
From WHO World Malaria report 2017 Q&A.
About insecticide resistance & malria burden :
http://www.who.int/malaria/media/world-malaria-report-2017-qa/en/
A large multicountry evaluation coordinated by WHO between 2011 and 2016 showed that insecticides continue to be an effective tool for malaria prevention, even in areas where mosquitoes have developed resistance to pyrethroids. Further, there is no clear correlation between insecticide resistance and trends in malaria burden: some countries with resistance to pyrethroids have shown reductions in disease burden; others with less resistance have shown an increase. Ultimately, we need more data on the public health impact of insecticide resistance and further investments in this area.

Also IRS coverage gone down probably because switching to more expensive insecticides :

The proportion of the population at risk protected by indoor residual spraying (IRS), an intervention that involves spraying the inside walls of dwellings with insecticides, declined globally from a peak of 5.8% in 2010 to 2.9% in 2016, with decreases seen in all WHO regions. The number of people protected in 2010 was 180 million globally, reducing to about 100 million in 2016. While there is yet no clear evidence of why this is happening, the decreases in coverage with IRS insecticides are occurring as countries change or rotate the chemicals they are using to try to prevent the spread of mosquitoes resistant to pyrethroids. Because alternative insecticides are more expensive than pyrethroids, increased funding for IRS is needed to maintain high coverage levels.

*8/1/2018*
assessing where I am with rotations

sensi_an_rotations1.Rmd is starting to do what I want.

When I set coverage to 1 and cost to 0 I get this :

run_rot(coverage=1)
Error in if (RAF[insecticide, sex, site, gen] < start_freqs[insecticide]) RAF[insecticide, : missing value where TRUE/FALSE needed

I suspect because when coverage=1 site='refugia' is not populated.

BEWARE I've added a few changes with major implications in to try to fix this ...

Might want to just put a condition in to not run migration when coverage=1

    # migration between refugia and intervention site
    RAF[,,,gen] <- rot_migrate(RAF[,,,gen], migration=migration, coverage=coverage)

*9/1/2018*

getting there with model working with no refugia
this works 
run_rot(coverage=1)

But knitting sensi_an_rotations1.Rmd
gives error in RAF1gen[] incorrect number of dimension calls
from insecticide_check() and I suspect because the site dimension has been dropped because it is just length 1

added drop=FALSE in insecticide_check()
but still seem to get error

may need to add drop=FALSE at other places in 
or maybe the build hasn't worked yet

I think working now.

*12/1/2018*

run_rot(coverage=1, rot_interval=0)

Error in RAF1gen[current_insecticide, "f", "intervention"] : 
  incorrect number of dimensions
Called from: insecticide_check(RAF1gen = RAF[, , , gen, drop = FALSE]


*19/1/2018*

model is now working with a coverage of 1

From GPIRM :
Idea that cost of resistance likely to decline when frequency of resistance gene has been high. (We don't have this in our models).
Insecticide resistance management strategies must, however, be implemented before the resistance gene becomes common and stable in the population; otherwise, the resistant gene will not recede even if use of the insecticide causing selection pressure is discontinued. As demonstrated by a study of blowflies by McKenzie and Whitten in 1982 (3), fitness cost is not an intrinsic property of the gene. Therefore, if that gene is allowed sufficient time to become common in a population, the rest of the genome will adapt to incorporate it without a significant fitness cost. At this point, even if the selection pressure is removed, the resistance gene will remain in the population.

But I looked at the 1982 paper and not sure it supports that ?
Seems to me that McKenzie1982 shows that relative fitness of the susceptible genotypes increase over time as would be expected by a decline in the concentration of the active ingredient ? (and similar to our WoS paper)

Example of sequential use and cost from GPIRM
Example in Colombia: resistance genes disappeared from the vector population when selection pressure was removed. A report submitted by WHO AMRO regional entomologists showed that, in 2005–2006, resistance to pyrethroids and DDT was identified in An. darlingi. A decision was quickly made to change to fenitrothion, an organophosphate with a different mode of action, for IRS. Rapid implementation of this alternative, which thereby removed the selection pressure, reduced the
frequency of resistance. In 2010, susceptibility tests showed that the frequency of resistance genes in the vector population had dropped below the level of detection, and pyrethroids were once again introduced into the IRS programme, albeit on a more limited scale.


Working on rotations_story.Rmd to create visuals about rotations we can use in upcoming talks.

*22/1/2018*

Why do rotations last longer than sequences ? (even when coverage=1 & cost=0)

I think it's just because the rotation interval continues to its end.

e.g. added an option to plot a 2nd scenario to rot_plot_resistance()

dfrot0 <- run_rot(n_insecticides=2, rot_interval=0, expo_hi=0.5, eff=0.5, cost=0, coverage=1)
dfrot15 <- run_rot(n_insecticides=2, rot_interval=15, expo_hi=0.5, eff=0.5, cost=0, coverage=1)
rot_plot_resistance(dfrot0, df_resanother=dfrot15, plot_refuge=FALSE)

So maybe we should have assessment of the resistance frequency in the rotation strategy too ?
I could add it as a flag.

done, now works for simple scenario

BUT rotations still lasting a few generations longer in later scenarios ?
dfseq <- run_rot(n_insecticides=2, rot_interval=0, expo_hi=0.5, eff=0.5, cost=0.01, coverage=1)
dfrot <- run_rot(n_insecticides=2, rot_interval=15, expo_hi=0.5, eff=0.5, cost=0.01, coverage=1)
rot_plot_resistance(dfrot, df_resanother=dfseq, plot_refuge=FALSE)

rotation
insecticide2 192 2 active 0.46672149
insecticide2 193 2 active 0.48524932
insecticide2 194 NA active 0.50379224

sequence
insecticide1 187 0.4710576
insecticide1 188 0.4895936
insecticide1 189 0.5081326


Could it be because an extra generation is slipped in at each rotation switchover ?
Or might be that more decline happens in rotations

Actually I think it's due to min_rwr_interval which was set at 5 by default and in the current code is implemented for sequence but not for rotation.

hmmm but even when I set min_rwr_interval to 1 there seems to be the difference ?
is there any info in the console messages ?

###rotation :
generation 166, switch from insecticide 1 to 2; frequencies = 0.402193 and 0.178446
generation 181, switch from insecticide 2 to 1; frequencies = 0.402193 and 0.384221
generation 188, switch from insecticide 1 to 2; frequencies = 0.512362 and 0.393770

simulation terminating at generation 194 because all RAFs above threshold of 0.500000

frequency of resistance in females to insecticide 1 is 0.504826
frequency of resistance in females to insecticide 2 is 0.503792

###sequence :
generation 92, switch from insecticide 1 to 2; frequencies = 0.510798 and 0.001000
generation 183, switch from insecticide 2 to 1; frequencies = 0.510798 and 0.397957

simulation terminating at generation 189 because all RAFs above threshold of 0.500000

frequency of resistance in females to insecticide 1 is 0.508133
frequency of resistance in females to insecticide 2 is 0.503261



Hi Ian,

I'm looking into rotations and mostly I find very little difference from sequences even with costs or refuges. In a sequence resistance builds up once and then declines, in rotations it builds up in steps and declines in between but the time-to-resistance is the same for both.  

Then I refound this idea in GPIRM that costs of resistance are likely to decline when frequency of resistance gene has been high. 

"Insecticide resistance management strategies must, however, be implemented before the resistance gene becomes common and stable in the population; otherwise, the resistant gene will not recede even if use of the insecticide causing selection pressure is discontinued. As demonstrated by a study of blowflies by McKenzie and Whitten in 1982 (3), fitness cost is not an intrinsic property of the gene. Therefore, if that gene is allowed sufficient time to become common in a population, the rest of the genome will adapt to incorporate it without a significant fitness cost. At this point, even if the selection pressure is removed, the resistance gene will remain in the population."

If this was the case it would probably favour rotations over sequences.

Do you have any thoughts ? Do you think it likely that costs will decline over time at high resistance frequencies ?

I looked at the 1982 paper (attached) and I don't think it supports the idea that costs decline over time (but it does seem to have data on relative fitness of RR,RS,SS that we could use in the WoS paper, gives evidence for dominance changing over time and could be used to derive our model parameters.)

Andy

Thanks Andy
 
That results should put the cat amongst the pigeons i.e. little difference between sequences and rotations.
 
There are examples of “compensatory” mutations offsetting the fitness cost of a mutation. Often from bacteria where populations can be very high and the population is asexual so that the mutation and modifier are always linked. It is less well studied in larger animals. There may be examples from IR but I am unaware. Often it is a post hoc explanation plucked out the air to explain why there is no apparent fitness effect i.e. “there were fitness effect, but they must have been modified”.
 
I like the 1982 paper… I have put it in the WoS folder with a note to discuss it.

*25/1/2018*

noticed that rotation plots don't have a log y axis where resistance plots do.
There is a logy option in run_rot() should probably set that TRUE by default.
yes fixed

Rowland(1981) has some good stuff on costs of resistance and selection coefficients and putting these into a model and testing against field data :

Withdrawal of dieldrin in two regions of India led to the frequency of SS increasing from 0.31 to 0.62 within 7 months (Rao et al., 1960) and from 0.11 to 0.85 within 9 months (Bhatia & Deobhankar, 1963).
In Fig. 9 the computed reversions in An.garnbiae and Anstephemi have been redrawn, expressed in terms of SS rather than R frequency. Superimposed on these are the An. culicifacies field reversions. Assuming that one generation takes 1 month (cf. Curtis et al., 1978), the computer
predictions seem to be consistent with the field reversions. 

Having established why and to what extent resistance should revert when cyclodiene usage is ended, the question remains could yHCH be effectively re-introduced at a later date as part of a insecticide-rotation resistance management strategy? Because RR is the most deleterious genotype, the rate of reversion should be rapid initially. Only when R is predominantly carried by heterozygotes would the rate of reversion begin to slow down. For this reason resistance cannot be expected to revert completely, but it should nevertheless revert sufficiently to warrant the useful re-introduction of yHCH for several generations at a time. An unresolved question, potentially damagingto the long-term future of the rotation strategy,is would modifiers of fitness evolve if cyclodieneusage was prolonged?

It seems, then, that rotation strategies might prolong dieldrin efficacy indefinitely, not just against anophelines but against many species of insect. 

[because the combination of selection coefficient, cost and dominance means that resistance doesn't rise too fast when used and declines when not in use].

Rowland2013 data on hut trials of actellic - pirimphos-methyl - an OP. Includes monthly change and at diff concentrations so could be useful for WoS, but doesn't have resistant & susceptible (does have resistance frequencies).

Matowo2015 selection of insecticide resistance, seems to show changing insecticide resistance in response to interventions. but only shows mortality change not resistance frequency change.

Kim2016 interesting risk paper :
The main policy implication of this analysis is that evolutionary speed of insecticide resistance and
maximal larviciding efficacy strongly affect the preferred actions implied by our decision analysis tool and that these parameters jointly offer the largest potential benefits from reduced uncertainty

*26/1/2018*
new UI resistrot, similar name to resistmixseq


*1/2/2018*

I want to create a figure that shows effect of untreated area, refugia
Can I do this in ggplot2, or do it in powerpoint ?
see : resistance-dispersal-dilution-figure.pptx

How to create a greater effect of dispersal, reduce the coverage.

run_rot(n_insecticides = 1)
Error in RAF1gen[, , "intervention"] : incorrect number of dimensions
Called from: rot_migrate(RAF[, , , gen], migration = migration, coverage = coverage)

but this is OK
run_rot(n_insecticides = 1, coverage=1)

I suspect problem is with dropping dimensions in rot_migrate when there's just one insecticide
For now just force n_insecticides > 1 from the UI


# TODO

~ can we do cross resistance within the rotations model ? i.e. that resistance to one insecticide also provides some protection against another ? 

~ something not right, when run with coverage=0 still get increase in resistance in treated areas, even though technically there is no treated area, maybe I just need to force coverage to be > 0 :
run_rot( n_insecticides = 3 , max_gen = 150 , start_freqs = 0.01 , rot_interval = 0 , eff = 0.8 , dom_sel = 0.5 , dom_cos = 0.5 , rr = 0.5 , expo_hi = 0.5 , coverage = 0 , migration = 0.01 , cost = 0.01 , logy = TRUE no_r_below_start = TRUE min_rwr_interval = 5 )


~ add error-check to run_rot if n.insecticides=1 & migration > 0 

Maybe explore idea from Rowland (1981) that resistance declines faster when it is mostly held by the RR (i.e. at higher allele frequencies) 

Look into data on changing allele frequencies over time (e.g. for Kdr)...

It occurred to me that maybe a benefit of rotations is that if it is difficult to measure resistance allele frequencies they provide a lower risk of reaching resistance thresholds for any insecticide. i.e. are they a better strategy in light of uncertainty in resistance allele frequencies ?


~ check again on current small differences between rotations & sequences




~ maybe I can write a function to plot 2 scenarios on the same graph (in the same way that curtis fig2 plots mix & seq on same graph) ?
~ I could have the insecticide use still along the top but with diff colours showing the two alternatives


~ get sensi_an_rotations1.Rmd working for Ians Q1

~ can we get cost to decrease over time at high frequency as suggested in GPIRM ?

gens_dep_under50 is ugly and I need to rewrite in sensi_an_rotations !

BEWARE active in active_or_refuge is potentially confusing, does not mean that insecticide is active/deployed, just means its is the active area (a different insecticide may be deployed)


*Ian said first question is to assess whether there is any benefit to rotations when there are no costs and no emigration*

*protocol for sensitivity analysis*
~ store input ranges
~ generate inputs for each run
~ run
~ store outputs
~ calculate output summary stats per run
~ concatenate inputs & outputs
~ relate outputs to inputs


~ create a new version of run_rot2() allowing me to refactor the code and check that it still generates same results as run_rot() 

~ maybe have a set_raf() function too

~ sort outputs which need to be time to resistance for planned rotations and RwR rotate when resistant. Sequence.

~ time under resitance threshold, e.g. 50%

Test 1. No refugia (i.e. Coverage=100%) or fitness costs.
Would expect all policies to be equivalent.

Test 2. Dominance of resistance and fitness costs both set to 0.5.
I suspect one of the advantages of rotations (and the presence of refugia) is that they maintain lower resistance allele frequencies which slows the spread of recessive resistance alleles. I suspect/guess/intuit that if we make them semi-dominate these effects should disappear and all policies should be the same. I’m probably wrong but it’s a nice test…..


~ Ian & I talked about using fitness to determine changes. and that fitness could be used as an index of population, but Ian was sceptical, he said to look up fitness determinants of population on wikipedia, about soft & hard selection.






~ test fitness_single_locus() from run_rot() and add to Rmd

~ check in resistance::fitnessSingleLocus() on separation of dominance of cost & selection. Was probably OK for Levick et al because we didn't have cost in. 
But I think that dominance of cost may be set to 0 which means that the RS experiences no effect of cost.

    a_dom       <- array_named(locusNum=c(1,2), exposure=c('no','lo','hi')) 
    a_dom[1, 'hi'] <- dom1
    a_dom[2, 'hi'] <- dom2
    
    #exposure 0 'no'
    a_fitloc[ paste0('RS',locusNum), 'no'] <- 1 - (a_dom[locusNum, 'no'] * a_cost[locusNum])
    a_fitloc[ paste0('RR',locusNum), 'no'] <- 1 - a_cost[locusNum]


# state of play
~ sensi_an_rotations1.Rmd : starting on sensitivity analysis
~~  produces an output dataframe containing both inputs and outputs

~ rotations1.Rmd : example plots
~ UI : rotations/shiny/rotresist1/server.r
      https://andysouth.shinyapps.io/rotresist1/
~ RAF[,,,2] to get allele frequencies for generation 2 (by insecticide,sex and active|refuge)

~ c 15 generations per year for mosquitos, 25 day generation time.
~ 3 years = 45 generations
~ https://www.cdc.gov/malaria/about/biology/mosquitoes/
~


# funding opportunities
https://lstmed.sharepoint.com/research/RBPS/Pages/Funding%20Information/Funding-Opportunities.aspx     
https://www.researchprofessional.com/funding/simple?q=software#1509451534514
                         